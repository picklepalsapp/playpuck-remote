<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PlayPUCK BLE Control</title>

  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --border: #e2e8f0;
      --shadow: 0 8px 30px rgba(2,8,23,.08);
      --accent: #635bff;   /* purply blue */
      --accent2: #10b981;  /* green */
      --danger: #ef4444;   /* red */
      --warn: #f59e0b;     /* amber */
      --btn: #111827;
      --btnText: #ffffff;
      --chip: #eef2ff;
      --success: #22c55e;
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: linear-gradient(180deg, #ffffff 0%, var(--bg) 65%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    header{
      padding: 16px 16px 10px;
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    header h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
    }
    header .status{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chip);
      color: var(--muted);
      border: 1px solid rgba(99,91,255,.15);
      white-space: nowrap;
    }

    main{
      padding: 14px 14px 26px;
      max-width: 760px;
      margin: 0 auto;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .cardHeader{
      padding: 14px 14px 10px;
      display:flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #fbfbff 100%);
    }
    .card .cardHeader h2{
      margin:0;
      font-size: 15px;
      line-height: 1.2;
    }
    .card .cardHeader p{
      margin: 6px 0 0;
      font-size: 12px;
      color: var(--muted);
    }
    .stepBadge{
      font-size: 12px;
      font-weight: 700;
      color: #1f2937;
      background: #f1f5f9;
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 999px;
      min-width: 46px;
      text-align:center;
    }

    .card .cardBody{ padding: 14px; }

    .row{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
      font-weight: 600;
    }

    input, select, textarea{
      width: 100%;
      padding: 12px 12px;
      font-size: 16px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      outline: none;
      box-shadow: 0 1px 0 rgba(2,8,23,.02);
    }
    textarea{ min-height: 110px; resize: vertical; }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(99,91,255,.5);
      box-shadow: 0 0 0 4px rgba(99,91,255,.12);
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .threeCol{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    button{
      -webkit-tap-highlight-color: transparent;
      appearance: none;
      border: 0;
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 16px;
      font-weight: 700;
      cursor:pointer;
      width: 100%;
      min-height: 48px;
      background: var(--btn);
      color: var(--btnText);
      box-shadow: 0 8px 18px rgba(17,24,39,.12);
      transition: transform .06s ease, box-shadow .2s ease, opacity .2s ease;
    }
    button:active{ transform: translateY(1px); }
    button.secondary{
      background: #ffffff;
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: 0 8px 18px rgba(2,8,23,.06);
    }
    button.accent{ background: var(--accent); }
    button.good{ background: var(--accent2); }
    button.warn{ background: var(--warn); }
    button.danger{ background: var(--danger); }

    button:disabled{
      opacity: .55;
      cursor:not-allowed;
      box-shadow: none;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #f8fafc;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.35;
    }

    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: #0b1220;
      color: #dbeafe;
      border-radius: 14px;
      padding: 12px;
      border: 1px solid rgba(226,232,240,.14);
      max-height: 200px;
      overflow:auto;
      white-space: pre-wrap;
    }

    .scoreboard{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .scoreTile{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfbff 100%);
      position: relative;
    }
    .scoreTile h3{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
    }
    .scoreVal{
      margin-top: 8px;
      font-size: 34px;
      font-weight: 900;
      letter-spacing: .6px;
    }

    /* Serving/info row */
    .infoRow{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .infoChip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #f8fafc;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
    }

    /* GAME OVER banner */
    .gameOver{
      display:none;
      margin-top: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      color: #7f1d1d;
      font-weight: 900;
      line-height: 1.2;
    }
    .gameOver small{
      display:block;
      margin-top:6px;
      font-weight:700;
      color:#7f1d1d;
      opacity:.9;
      font-size:12px;
    }

    /* NFC status */
    .nfcStatus{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #f8fafc;
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      line-height: 1.35;
    }

    /* üî¥ Red banner (only after failure) */
    .bleBanner{
      display:none;
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      background:#fee2e2;
      border:1px solid #fecaca;
      color:#7f1d1d;
      font-size:13px;
      line-height:1.35;
    }
    .bleBanner strong{ font-weight:900; }
    .bleBanner ul{ margin:8px 0 0 18px; padding:0; }

    /* ‚úÖ Green tick toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%);
      z-index:9999;
      display:none;
      align-items:center;
      gap:10px;
      background:#0b1220;
      color:#e5e7eb;
      border:1px solid rgba(226,232,240,.14);
      border-radius:999px;
      padding:10px 14px;
      box-shadow:0 18px 40px rgba(2,8,23,.25);
      pointer-events:none;
    }
    .toast.show{ display:flex; animation: toastIn .18s ease-out; }
    @keyframes toastIn{
      from{ transform: translateX(-50%) translateY(8px); opacity:0; }
      to{ transform: translateX(-50%) translateY(0); opacity:1; }
    }
    .tick{
      width:22px;height:22px;border-radius:999px;
      background:rgba(34,197,94,.16);
      border:1px solid rgba(34,197,94,.35);
      display:grid;place-items:center;
    }
    .tick svg{ width:14px;height:14px;stroke:var(--success);stroke-width:3;fill:none;stroke-linecap:round;stroke-linejoin:round; }

    /* Small checkbox row */
    .checkRow{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }
    .checkRow input[type="checkbox"]{
      width:20px;height:20px;
      margin:0;
      accent-color: var(--accent);
    }
    .checkRow span{
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
    }

    @media (max-width: 460px){
      .twoCol, .threeCol{ grid-template-columns: 1fr; }
      .scoreboard{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<header>
  <h1>
    PlayPUCK BLE Control
    <span id="connStatus" class="status">Disconnected</span>
  </h1>
</header>

<main>
  <div class="grid">

    <!-- 0) CONNECTION -->
    <section class="card" id="cardConnect">
      <div class="cardHeader">
        <div>
          <h2>BLE Connection</h2>
          <p>Connect to the PlayPUCK, then follow the steps in order.</p>
        </div>
        <div class="stepBadge">0</div>
      </div>
      <div class="cardBody">
        <div class="twoCol">
          <button id="btnConnect" class="accent">Connect</button>
          <button id="btnDisconnect" class="secondary" disabled>Disconnect</button>
        </div>

        <div id="bleBanner" class="bleBanner"></div>

        <div class="row" style="margin-top:10px;">
          <span class="pill" id="deviceNamePill">Device: ‚Äî</span>
          <span class="pill" id="rssiPill">RSSI: ‚Äî</span>
          <span class="pill" id="reconnectPill">Reconnect: ‚Äî</span>
        </div>

        <div style="margin-top:10px;">
          <div class="checkRow">
            <input id="autoReconnect" type="checkbox" checked>
            <span>Auto-reconnect BLE (recommended)</span>
          </div>
          <div class="hint">
            If OFF, the portal will not auto-reconnect after a drop or when the browser/tab returns to the foreground.
          </div>
        </div>

        <p class="hint">
          Note: Web Bluetooth availability varies by phone/browser.
          PlayPUCK supports <b>one BLE connection at a time</b> ‚Äî if you used <b>nRF Connect</b>, disconnect and force-close it.
        </p>
      </div>
    </section>

    <!-- 1) WIFI SETUP -->
    <section class="card" id="cardWifi">
      <div class="cardHeader">
        <div>
          <h2>Wi-Fi set up</h2>
          <p>Send SSID + password to the PlayPUCK. You can save known networks on this device.</p>
        </div>
        <div class="stepBadge">1</div>
      </div>
      <div class="cardBody">

        <div>
          <label for="savedWifi">Saved networks</label>
          <select id="savedWifi">
            <option value="" selected>‚Äî Select a saved SSID ‚Äî</option>
          </select>
          <div class="hint">
            Saved Wi-Fi is stored in <b>localStorage</b> on this device/browser.
            ‚ö†Ô∏è Passwords stored here are not secure on shared devices.
          </div>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <div>
            <label for="wifiSsid">Wi-Fi SSID</label>
            <input id="wifiSsid" autocomplete="username" placeholder="e.g. HomeWiFi">
          </div>
          <div>
            <label for="wifiPass">Wi-Fi Password</label>
            <input id="wifiPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
        </div>

        <div style="margin-top:10px;">
          <div class="checkRow">
            <input id="showWifiPass" type="checkbox">
            <span>Show password characters</span>
          </div>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <button id="btnSendWifi" class="good" disabled>Send Wi-Fi to PlayPUCK</button>
          <button id="btnSaveWifi" class="secondary">Save / Update Wi-Fi</button>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <button id="btnForgetWifi" class="warn">Forget selected SSID</button>
          <button id="btnClearWifi" class="danger">Clear ALL saved Wi-Fi</button>
        </div>

        <div class="hint">Sends <b>WIFI</b> with payload <code>{"ssid","pass"}</code>.</div>
      </div>
    </section>

    <!-- 2) MATCH SELECTION -->
    <section class="card" id="cardMatch">
      <div class="cardHeader">
        <div>
          <h2>Match selection</h2>
          <p>Choose rules/preset before uploading to the PlayPUCK.</p>
        </div>
        <div class="stepBadge">2</div>
      </div>

      <div class="cardBody">
        <div class="twoCol">
          <div>
            <label for="matchType">Format</label>
            <select id="matchType">
              <option value="DOUBLES" selected>DOUBLES</option>
              <option value="SINGLES">SINGLES</option>
            </select>
          </div>

          <div>
            <label for="scoringMode">Scoring</label>
            <select id="scoringMode">
              <option value="SIDEOUT" selected>SIDEOUT</option>
              <option value="RALLY">RALLY</option>
            </select>
          </div>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <div>
            <label for="winPointsPreset">First to‚Ä¶</label>
            <select id="winPointsPreset">
              <option value="7">7</option>
              <option value="11" selected>11</option>
              <option value="15">15</option>
              <option value="21">21</option>
            </select>
            <div class="hint">For anything else, use the JSON override below.</div>
          </div>

          <div>
            <label for="winRule">Win rule</label>
            <select id="winRule">
              <option value="SUDDEN_DEATH" selected>SUDDEN DEATH</option>
              <option value="TWO_CLEAR">2-CLEAR POINTS</option>
            </select>
          </div>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <div>
            <label for="matchId">Match ID (optional)</label>
            <input id="matchId" placeholder="e.g. OKEHAMPTON-2026-01-03-001">
          </div>

          <div>
            <label for="customOverride">Custom override</label>
            <select id="customOverride">
              <option value="OFF" selected>Use presets above</option>
              <option value="ON">Override with JSON below</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="matchJson">Match / Rules JSON</label>
          <textarea id="matchJson"
            placeholder='{"format":"DOUBLES","scoring":"SIDEOUT","win_points":11,"win_rule":"SUDDEN_DEATH"}'></textarea>
          <div class="hint">If override is ON, this JSON is uploaded exactly (plus match_id if provided).</div>
        </div>
      </div>
    </section>

    <!-- 2.5) PLAYER CHECK-IN -->
    <section class="card" id="cardCheckin">
      <div class="cardHeader">
        <div>
          <h2>Player check-in (NFC ‚Üí BLE)</h2>
          <p>Android Chrome/Edge only. Tap a tag to send <b>CHECKIN</b> to the PlayPUCK.</p>
        </div>
        <div class="stepBadge">2.5</div>
      </div>
      <div class="cardBody">
        <div class="twoCol">
          <button id="btnNfcScan" class="accent" disabled>Tap NFC to check in</button>
          <button id="btnNfcStop" class="secondary" disabled>Stop scan</button>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <div>
            <label for="checkinPlayerId">Manual player_id (test)</label>
            <input id="checkinPlayerId" placeholder="e.g. p1234 or UUID">
          </div>
          <div style="display:flex; flex-direction:column; justify-content:flex-end;">
            <button id="btnCheckinManual" class="good" disabled>Send CHECKIN</button>
          </div>
        </div>

        <div id="nfcStatus" class="nfcStatus">NFC idle.</div>
        <div class="hint">
          Tip: If your tags don‚Äôt contain NDEF data, Web NFC may still provide <code>serialNumber</code> on some devices.
        </div>
      </div>
    </section>

    <!-- 2.6) TAG TOOLS (ROLE BINDINGS) -->
    <section class="card" id="cardTags">
      <div class="cardHeader">
        <div>
          <h2>Tag tools (ROLE BINDINGS)</h2>
          <p>Register a tag‚Äôs <b>role</b> (persisted on puck) and set its <b>team</b> for this match. Then use <b>TAG_TAP</b>.</p>
        </div>
        <div class="stepBadge">2.6</div>
      </div>

      <div class="cardBody">
        <div class="twoCol">
          <div>
            <label for="tagUid">Tag UID (colon-hex)</label>
            <input id="tagUid" placeholder="e.g. 04:AA:BB:CC:DD:EE:FF">
          </div>
          <div>
            <label for="tagRole">Role (persisted)</label>
            <select id="tagRole">
              <option value="PLAYER" selected>PLAYER</option>
              <option value="ADMIN">ADMIN</option>
              <option value="REF">REF</option>
              <option value="NONE">NONE (unregister)</option>
            </select>
          </div>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <button id="btnTagRegister" class="accent" disabled>TAG_REGISTER (save role)</button>
          <button id="btnTagTap" class="good" disabled>TAG_TAP (use tag)</button>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <div>
            <label for="tagTeam">Team assignment (this match)</label>
            <select id="tagTeam">
              <option value="A" selected>Team A</option>
              <option value="B">Team B</option>
              <option value="NONE">NONE (remove assignment)</option>
            </select>
          </div>
          <div style="display:flex; flex-direction:column; justify-content:flex-end;">
            <button id="btnTagAssign" class="secondary" disabled>TAG_ASSIGN (set team)</button>
          </div>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <button id="btnTagClearTeams" class="warn" disabled>Clear team assignments</button>
          <button id="btnTagClearAll" class="danger" disabled>Clear roles + teams</button>
        </div>

        <div class="hint">
          Sends:
          <code>TAG_REGISTER {"uid":"‚Ä¶","role":"PLAYER"}</code><br>
          <code>TAG_ASSIGN {"uid":"‚Ä¶","team":"A"}</code><br>
          <code>TAG_TAP {"uid":"‚Ä¶","seq":1}</code><br>
          <code>TAG_CLEAR_TEAMS {"all":true}</code><br>
          <code>TAG_CLEAR_ALL {"all":true}</code>
        </div>
      </div>
    </section>

    <!-- 3) UPLOAD -->
    <section class="card" id="cardUpload">
      <div class="cardHeader">
        <div>
          <h2>Upload to PlayPUCK</h2>
          <p>Send match profile to the PlayPUCK (PROFILE_SELECT).</p>
        </div>
        <div class="stepBadge">3</div>
      </div>
      <div class="cardBody">
        <button id="btnUploadProfile" class="accent" disabled>Upload match to PlayPUCK</button>
      </div>
    </section>

    <!-- 4) START / END -->
    <section class="card" id="cardStart">
      <div class="cardHeader">
        <div>
          <h2>Start / End game</h2>
          <p>Start (START_GAME) or end (END_GAME) the match.</p>
        </div>
        <div class="stepBadge">4</div>
      </div>
      <div class="cardBody">
        <div class="twoCol">
          <button id="btnStartGame" class="good" disabled>Start game</button>
          <button id="btnEndGame" class="danger" disabled>End game</button>
        </div>
        <div class="hint">
          End game sends <b>END_GAME</b>. (Firmware must implement it; puck remains authoritative.)
        </div>
      </div>
    </section>

    <!-- 5) SCORE -->
    <section class="card" id="cardScore">
      <div class="cardHeader">
        <div>
          <h2>Score game</h2>
          <p>Team A / Team B rally winner buttons (puck applies rules).</p>
        </div>
        <div class="stepBadge">5</div>
      </div>

      <div class="cardBody">
        <!-- GAME OVER banner -->
        <div id="gameOverBanner" class="gameOver">
          GAME OVER ‚Äî <span id="gameOverWinner">‚Äî</span>
          <small id="gameOverSub">Final score: ‚Äî</small>
        </div>

        <div class="scoreboard">
          <div class="scoreTile">
            <h3>Team A</h3>
            <div id="scoreA" class="scoreVal">0</div>
          </div>
          <div class="scoreTile">
            <h3>Team B</h3>
            <div id="scoreB" class="scoreVal">0</div>
          </div>
        </div>

        <div class="infoRow">
          <span class="infoChip" id="infoServe">Serve: ‚Äî</span>
          <span class="infoChip" id="infoServerNum">Server: ‚Äî</span>
          <span class="infoChip" id="infoMode">Mode: ‚Äî</span>
          <span class="infoChip" id="infoTarget">First to: ‚Äî</span>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <button id="btnScoreA" class="accent" disabled>Point won by A</button>
          <button id="btnScoreB" class="accent" disabled>Point won by B</button>
        </div>

        <div class="hint">
          Buttons send <b>SCORE</b> with payload <code>{"team":"A|B","delta":1}</code> meaning:
          <b>‚ÄúTeam won the rally‚Äù</b>. The puck applies SIDEOUT/RALLY rules and notifies STATE/GAME_OVER.
        </div>
      </div>
    </section>

    <!-- 6) EDIT SCORE -->
    <section class="card" id="cardEdit">
      <div class="cardHeader">
        <div>
          <h2>Edit score</h2>
          <p>Admin correction (puck stays authoritative).</p>
        </div>
        <div class="stepBadge">6</div>
      </div>
      <div class="cardBody">
        <div class="twoCol">
          <div class="threeCol">
            <button id="btnAminus" class="secondary" disabled>‚àí A</button>
            <button id="btnAplus" class="secondary" disabled>+ A</button>
            <button id="btnAset" class="warn" disabled>Set A</button>
          </div>
          <div class="threeCol">
            <button id="btnBminus" class="secondary" disabled>‚àí B</button>
            <button id="btnBplus" class="secondary" disabled>+ B</button>
            <button id="btnBset" class="warn" disabled>Set B</button>
          </div>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <div>
            <label for="setAVal">Set Team A to‚Ä¶</label>
            <input id="setAVal" type="number" inputmode="numeric" min="0" step="1" value="0">
          </div>
          <div>
            <label for="setBVal">Set Team B to‚Ä¶</label>
            <input id="setBVal" type="number" inputmode="numeric" min="0" step="1" value="0">
          </div>
        </div>
      </div>
    </section>

    <!-- LOG -->
    <section class="card">
      <div class="cardHeader">
        <div>
          <h2>Debug log</h2>
          <p>Messages sent/received.</p>
        </div>
        <div class="stepBadge">LOG</div>
      </div>
      <div class="cardBody">
        <div id="log" class="log"></div>
      </div>
    </section>

  </div>
</main>

<div id="toast" class="toast" aria-live="polite">
  <span class="tick" aria-hidden="true">
    <svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"></path></svg>
  </span>
  <span id="toastText">Connected</span>
</div>

<script>
const BLE = {
  SERVICE_UUID: '0000ffff-0000-1000-8000-00805f9b34fb',
  TX_CHAR_UUID: '0000ff01-0000-1000-8000-00805f9b34fb',
  RX_CHAR_UUID: '0000ff02-0000-1000-8000-00805f9b34fb',
};

const el = (id) => document.getElementById(id);
const logEl = el('log');
const connStatus = el('connStatus');
const deviceNamePill = el('deviceNamePill');
const rssiPill = el('rssiPill');
const reconnectPill = el('reconnectPill');
const bleBanner = el('bleBanner');

const toast = el('toast');
const toastText = el('toastText');

function log(msg){
  const ts = new Date().toLocaleTimeString();
  logEl.textContent = `[${ts}] ${msg}\n` + logEl.textContent;
}
function showToast(t){
  toastText.textContent = t;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),1300);
}
function vibrate(pattern){
  try{ if(navigator.vibrate) navigator.vibrate(pattern); }catch(_){}
}
function showBanner(html){
  bleBanner.innerHTML = html;
  bleBanner.style.display = 'block';
}
function hideBanner(){
  bleBanner.style.display = 'none';
  bleBanner.innerHTML = '';
}
function looksLikeBleBusy(errMsg){
  const m = String(errMsg || '').toLowerCase();
  return (
    (m.includes('gatt') && m.includes('busy')) ||
    m.includes('operation already in progress') ||
    m.includes('failed to connect') ||
    m.includes('networkerror') ||
    m.includes('notpermittederror') ||
    m.includes('securityerror')
  );
}

const btnConnect = el('btnConnect');
const btnDisconnect = el('btnDisconnect');
const autoReconnect = el('autoReconnect');

const savedWifi = el('savedWifi');
const wifiSsid = el('wifiSsid');
const wifiPass = el('wifiPass');
const showWifiPass = el('showWifiPass');
const btnSendWifi = el('btnSendWifi');
const btnSaveWifi = el('btnSaveWifi');
const btnForgetWifi = el('btnForgetWifi');
const btnClearWifi = el('btnClearWifi');

const matchType = el('matchType');
const scoringMode = el('scoringMode');
const winPointsPreset = el('winPointsPreset');
const winRule = el('winRule');
const matchId = el('matchId');
const customOverride = el('customOverride');
const matchJson = el('matchJson');

const btnUploadProfile = el('btnUploadProfile');
const btnStartGame = el('btnStartGame');
const btnEndGame = el('btnEndGame');

const btnScoreA = el('btnScoreA');
const btnScoreB = el('btnScoreB');

const btnAminus = el('btnAminus');
const btnAplus  = el('btnAplus');
const btnAset   = el('btnAset');

const btnBminus = el('btnBminus');
const btnBplus  = el('btnBplus');
const btnBset   = el('btnBset');

const scoreAEl = el('scoreA');
const scoreBEl = el('scoreB');

const setAVal = el('setAVal');
const setBVal = el('setBVal');

const btnNfcScan = el('btnNfcScan');
const btnNfcStop = el('btnNfcStop');
const nfcStatusEl = el('nfcStatus');
const checkinPlayerId = el('checkinPlayerId');
const btnCheckinManual = el('btnCheckinManual');

// Tag tools
const tagUid = el('tagUid');
const tagRole = el('tagRole');
const tagTeam = el('tagTeam');
const btnTagRegister = el('btnTagRegister');
const btnTagAssign = el('btnTagAssign');
const btnTagTap = el('btnTagTap');
const btnTagClearTeams = el('btnTagClearTeams');
const btnTagClearAll = el('btnTagClearAll');
let tagSeq = 1;
function normUid(u){ return String(u || '').trim().toUpperCase(); }

// UI bits
const gameOverBanner = el('gameOverBanner');
const gameOverWinner = el('gameOverWinner');
const gameOverSub = el('gameOverSub');
const infoServe = el('infoServe');
const infoServerNum = el('infoServerNum');
const infoMode = el('infoMode');
const infoTarget = el('infoTarget');

let device = null;
let server = null;
let service = null;
let txChar = null;
let rxChar = null;

let ndef = null;
let nfcActive = false;

let hadConnectFailure = false;
let reconnectTimer = null;
let reconnectBackoffMs = 900;
const reconnectBackoffMaxMs = 12000;

/* ---------- localStorage keys ---------- */
const LS_WIFI_KEY = 'playpuck_wifi_saved_v1';
const LS_STATE_KEY = 'playpuck_last_state_v1';
const LS_AUTORECON_KEY = 'playpuck_auto_reconnect_v1';

function safeJsonParse(s, fallback){
  try{ return JSON.parse(s); }catch(_){ return fallback; }
}

/* ---------- Saved Wi-Fi ---------- */
function loadSavedWifi(){
  const arr = safeJsonParse(localStorage.getItem(LS_WIFI_KEY) || '[]', []);
  return Array.isArray(arr) ? arr : [];
}
function saveSavedWifi(arr){
  localStorage.setItem(LS_WIFI_KEY, JSON.stringify(arr || []));
}
function renderSavedWifiDropdown(selectedSsid=''){
  const arr = loadSavedWifi()
    .slice()
    .sort((a,b)=>String(a.ssid||'').localeCompare(String(b.ssid||'')));

  // rebuild options
  savedWifi.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.textContent = '‚Äî Select a saved SSID ‚Äî';
  savedWifi.appendChild(opt0);

  for(const item of arr){
    const ssid = String(item.ssid || '');
    if(!ssid) continue;
    const o = document.createElement('option');
    o.value = ssid;
    o.textContent = ssid;
    if(selectedSsid && selectedSsid === ssid) o.selected = true;
    savedWifi.appendChild(o);
  }
}
function upsertWifi(ssid, pass){
  ssid = String(ssid||'').trim();
  pass = String(pass||'');
  if(!ssid) throw new Error('SSID is empty.');

  const arr = loadSavedWifi();
  const idx = arr.findIndex(x => String(x.ssid||'') === ssid);
  const entry = { ssid, pass, updated_at: Date.now() };

  if(idx >= 0) arr[idx] = entry;
  else arr.push(entry);

  saveSavedWifi(arr);
  renderSavedWifiDropdown(ssid);
}
function forgetWifi(ssid){
  ssid = String(ssid||'').trim();
  if(!ssid) return;
  const arr = loadSavedWifi().filter(x => String(x.ssid||'') !== ssid);
  saveSavedWifi(arr);
  renderSavedWifiDropdown('');
}
function clearAllWifi(){
  saveSavedWifi([]);
  renderSavedWifiDropdown('');
}

savedWifi.addEventListener('change', () => {
  const ssid = savedWifi.value;
  if(!ssid) return;
  const arr = loadSavedWifi();
  const found = arr.find(x => String(x.ssid||'') === ssid);
  if(found){
    wifiSsid.value = String(found.ssid||'');
    wifiPass.value = String(found.pass||'');
    log(`Loaded saved Wi-Fi: ${ssid}`);
  }
});

btnSaveWifi.addEventListener('click', () => {
  try{
    upsertWifi(wifiSsid.value, wifiPass.value);
    showToast('Saved Wi-Fi ‚úÖ');
    log(`Saved Wi-Fi: ${wifiSsid.value.trim()}`);
  }catch(e){
    log(`Save Wi-Fi error: ${e.message}`);
  }
});
btnForgetWifi.addEventListener('click', () => {
  const ssid = savedWifi.value || wifiSsid.value.trim();
  if(!ssid) return log('Forget Wi-Fi: select or enter an SSID first.');
  forgetWifi(ssid);
  showToast('Forgot Wi-Fi');
  log(`Forgot saved Wi-Fi: ${ssid}`);
});
btnClearWifi.addEventListener('click', () => {
  clearAllWifi();
  showToast('Cleared Wi-Fi');
  log('Cleared ALL saved Wi-Fi.');
});

showWifiPass.addEventListener('change', () => {
  wifiPass.type = showWifiPass.checked ? 'text' : 'password';
});

/* ---------- Auto-reconnect toggle persistence ---------- */
function loadAutoReconnect(){
  const v = localStorage.getItem(LS_AUTORECON_KEY);
  if(v === null) return true; // default ON
  return v === '1';
}
function saveAutoReconnect(v){
  localStorage.setItem(LS_AUTORECON_KEY, v ? '1' : '0');
}
autoReconnect.checked = loadAutoReconnect();
autoReconnect.addEventListener('change', () => {
  saveAutoReconnect(autoReconnect.checked);
  if(!autoReconnect.checked){
    resetReconnect();
    setReconnectPill('OFF');
    log('Auto-reconnect disabled.');
  }else{
    setReconnectPill('‚Äî');
    log('Auto-reconnect enabled.');
  }
});

/* ---------- Local view-model ONLY (comes from STATE) ---------- */
let lastState = {
  a: 0, b: 0,
  serving: null,
  server_num: null,
  mode: null,
  format: null,
  win_points: null,
  win_rule: null,
  game_over: false,
  winner: null
};

function persistLastState(){
  try{
    localStorage.setItem(LS_STATE_KEY, JSON.stringify(lastState));
  }catch(_){}
}
function restoreLastState(){
  const obj = safeJsonParse(localStorage.getItem(LS_STATE_KEY) || 'null', null);
  if(obj && typeof obj === 'object'){
    lastState = Object.assign({}, lastState, obj);
  }
}

function setNfcStatus(t){ if(nfcStatusEl) nfcStatusEl.textContent = t; }
function setReconnectPill(text){ reconnectPill.textContent = `Reconnect: ${text}`; }

function enc(str){ return new TextEncoder().encode(str); }

async function bleSend(command, payloadObj=null){
  if(!txChar) throw new Error('Not connected / TX characteristic missing.');
  const payload = payloadObj ? JSON.stringify(payloadObj) : '';
  const line = payload ? `${command} ${payload}` : `${command}`;
  await txChar.writeValue(enc(line));
  log(`‚Üí ${line}`);
}

function setScore(a,b){
  scoreAEl.textContent = String(a);
  scoreBEl.textContent = String(b);
  setAVal.value = String(a);
  setBVal.value = String(b);
}

function setGameOverUI(isOver, winner, a, b){
  if(isOver){
    gameOverBanner.style.display = 'block';
    gameOverWinner.textContent = winner ? `${winner} WINS` : '‚Äî';
    gameOverSub.textContent = `Final score: A ${a} - ${b} B`;
    btnScoreA.disabled = true;
    btnScoreB.disabled = true;
  }else{
    gameOverBanner.style.display = 'none';
    gameOverWinner.textContent = '‚Äî';
    gameOverSub.textContent = 'Final score: ‚Äî';
  }
}

function renderStateUI(){
  setScore(lastState.a ?? 0, lastState.b ?? 0);

  infoServe.textContent = lastState.serving ? `Serve: ${lastState.serving}` : 'Serve: ‚Äî';
  infoServerNum.textContent = lastState.server_num ? `Server: ${lastState.server_num}` : 'Server: ‚Äî';
  infoMode.textContent = lastState.mode ? `Mode: ${lastState.mode}` : 'Mode: ‚Äî';
  infoTarget.textContent = lastState.win_points ? `First to: ${lastState.win_points}` : 'First to: ‚Äî';

  setGameOverUI(!!lastState.game_over, (lastState.winner || null), lastState.a ?? 0, lastState.b ?? 0);

  if(txChar && !lastState.game_over){
    btnScoreA.disabled = false;
    btnScoreB.disabled = false;
  }
}

function parseRx(text){
  try{
    const trimmed = text.trim();
    const sp = trimmed.indexOf(' ');
    const cmd = sp >= 0 ? trimmed.slice(0, sp) : trimmed;
    const json = sp >= 0 ? trimmed.slice(sp + 1) : '';

    if(cmd === 'STATE' && json){
      const obj = JSON.parse(json);

      lastState.a = (typeof obj.a === 'number') ? obj.a : lastState.a;
      lastState.b = (typeof obj.b === 'number') ? obj.b : lastState.b;
      if(typeof obj.serving === 'string') lastState.serving = obj.serving;
      if(typeof obj.server_num === 'number') lastState.server_num = obj.server_num;
      if(typeof obj.mode === 'string') lastState.mode = obj.mode;
      if(typeof obj.format === 'string') lastState.format = obj.format;
      if(typeof obj.win_points === 'number') lastState.win_points = obj.win_points;
      if(typeof obj.win_rule === 'string') lastState.win_rule = obj.win_rule;
      if(typeof obj.game_over === 'boolean') lastState.game_over = obj.game_over;

      if(!lastState.game_over) lastState.winner = null;

      renderStateUI();
      persistLastState();
      return;
    }

    if(cmd === 'GAME_OVER' && json){
      const obj = JSON.parse(json);
      if(typeof obj.winner === 'string') lastState.winner = obj.winner;
      if(typeof obj.a === 'number') lastState.a = obj.a;
      if(typeof obj.b === 'number') lastState.b = obj.b;
      lastState.game_over = true;

      renderStateUI();
      persistLastState();

      vibrate([80,40,80,40,200]);
      showToast(`Game Over ‚Äî ${lastState.winner || ''}`);
      return;
    }

  }catch(_){ /* ignore */ }
}

/* ---------- MATCH PAYLOAD (presets) ---------- */
function buildMatchPayload(){
  if(customOverride.value === 'ON'){
    let obj;
    try { obj = JSON.parse(matchJson.value); }
    catch { throw new Error('Custom JSON invalid.'); }
    const id = matchId.value.trim();
    if(id) obj.match_id = id;
    return obj;
  }

  const id = matchId.value.trim() || null;
  const payload = {
    format: matchType.value,
    scoring: scoringMode.value,
    win_points: Number(winPointsPreset.value),
    win_rule: winRule.value,
  };
  if(id) payload.match_id = id;
  return payload;
}

function syncJsonPreview(){
  if(customOverride.value === 'OFF'){
    try{ matchJson.value = JSON.stringify(buildMatchPayload(), null, 2); }catch(_){}
  }
}
[matchType, scoringMode, winPointsPreset, winRule, customOverride, matchId]
  .forEach(x => x.addEventListener('change', syncJsonPreview));
syncJsonPreview();

/* ---------- CHECK-IN (manual + NFC) ---------- */
async function sendCheckin(playerIdRaw){
  const playerId = String(playerIdRaw || '').trim();
  if(!playerId){
    log('Check-in: player_id is empty.');
    setNfcStatus('Enter a player_id or tap a tag.');
    return;
  }
  try{
    await bleSend('CHECKIN', { player_id: playerId });
    setNfcStatus(`‚úÖ Sent CHECKIN for: ${playerId}`);
  }catch(e){
    log(`Check-in send error: ${e.message}`);
    setNfcStatus(`‚ùå BLE send failed: ${e.message}`);
  }
}

btnCheckinManual.addEventListener('click', async () => {
  await sendCheckin(checkinPlayerId.value);
});

function decodeRecordText(record){
  const dec = new TextDecoder((record.encoding || 'utf-8'));
  return dec.decode(record.data);
}
function tryExtractPlayerIdFromText(text){
  const t = String(text || '').trim();
  if(!t) return null;
  try{
    const obj = JSON.parse(t);
    if(obj && (obj.player_id || obj.pid)){
      return String(obj.player_id || obj.pid);
    }
  }catch(_){}
  return t;
}
function tryExtractPlayerIdFromUrl(urlText){
  const t = String(urlText || '').trim();
  if(!t) return null;
  try{
    const u = new URL(t);
    return u.searchParams.get('pid') || u.searchParams.get('player_id');
  }catch(_){
    return null;
  }
}

async function startNfcScan(){
  if(!('NDEFReader' in window)){
    setNfcStatus('Web NFC not available (Android Chrome/Edge required).');
    return;
  }
  if(!txChar){
    setNfcStatus('Connect to the PlayPUCK first (BLE).');
    return;
  }

  try{
    ndef = new NDEFReader();
    setNfcStatus('Requesting NFC permission‚Ä¶');
    await ndef.scan();
    nfcActive = true;
    setNfcStatus('NFC ready ‚Äî tap a player tag.');

    btnNfcStop.disabled = false;
    btnNfcScan.disabled = true;

    ndef.onreading = async (event) => {
      try{
        let playerId = null;

        for(const record of event.message.records){
          if(record.recordType === 'text'){
            const txt = decodeRecordText(record);
            playerId = tryExtractPlayerIdFromText(txt);
          } else if(record.recordType === 'url'){
            const urlTxt = decodeRecordText(record);
            playerId = tryExtractPlayerIdFromUrl(urlTxt) || tryExtractPlayerIdFromText(urlTxt);
          }
          if(playerId) break;
        }

        if(!playerId){
          if(event && event.serialNumber) playerId = String(event.serialNumber).trim();
        }

        if(!playerId){
          setNfcStatus('Tag read, but no player_id found.');
          log('NFC: Tag read, but player_id not extracted.');
          return;
        }

        setNfcStatus(`Read tag for: ${playerId} ‚Äî sending CHECKIN‚Ä¶`);
        log(`NFC ‚Üí player_id=${playerId}`);
        await sendCheckin(playerId);

      }catch(e){
        log(`NFC onreading error: ${e.message}`);
        setNfcStatus(`NFC read error: ${e.message}`);
      }
    };

    ndef.onreadingerror = () => {
      setNfcStatus('NFC reading error ‚Äî try again.');
      log('NFC reading error.');
    };

  }catch(err){
    nfcActive = false;
    btnNfcStop.disabled = true;
    btnNfcScan.disabled = !(txChar && ('NDEFReader' in window));
    setNfcStatus(`NFC error: ${err?.message || err}`);
    log(`NFC error: ${err?.message || err}`);
  }
}

function stopNfcScan(){
  nfcActive = false;
  if(ndef){
    ndef.onreading = null;
    ndef.onreadingerror = null;
  }
  btnNfcStop.disabled = true;
  btnNfcScan.disabled = !(txChar && ('NDEFReader' in window));
  setNfcStatus('NFC stopped. Tap ‚ÄúTap NFC to check in‚Äù to start again.');
  log('NFC scan stopped (handlers removed).');
}

btnNfcScan.addEventListener('click', startNfcScan);
btnNfcStop.addEventListener('click', stopNfcScan);

if(!('NDEFReader' in window)){
  setNfcStatus('Web NFC not available on this device/browser (Android Chrome/Edge required).');
} else {
  setNfcStatus('NFC available. Connect BLE, then tap ‚ÄúTap NFC to check in‚Äù.');
}

/* ---------- TAG TOOLS (ROLE BINDINGS) ---------- */
btnTagRegister.addEventListener('click', async () => {
  try{
    const uid = normUid(tagUid.value);
    const role = String(tagRole.value || '').trim();
    if(!uid) return log('TAG_REGISTER: enter a UID first.');
    await bleSend('TAG_REGISTER', { uid, role });
  }catch(e){
    log(`TAG_REGISTER error: ${e.message}`);
  }
});

btnTagAssign.addEventListener('click', async () => {
  try{
    const uid = normUid(tagUid.value);
    const team = String(tagTeam.value || '').trim(); // A|B|NONE
    if(!uid) return log('TAG_ASSIGN: enter a UID first.');
    await bleSend('TAG_ASSIGN', { uid, team });
  }catch(e){
    log(`TAG_ASSIGN error: ${e.message}`);
  }
});

btnTagTap.addEventListener('click', async () => {
  try{
    const uid = normUid(tagUid.value);
    if(!uid) return log('TAG_TAP: enter a UID first.');
    await bleSend('TAG_TAP', { uid, seq: tagSeq++ });
  }catch(e){
    log(`TAG_TAP error: ${e.message}`);
  }
});

btnTagClearTeams.addEventListener('click', async () => {
  try{
    await bleSend('TAG_CLEAR_TEAMS', { all: true });
    log('Cleared team assignments.');
  }catch(e){
    log(`TAG_CLEAR_TEAMS error: ${e.message}`);
  }
});

btnTagClearAll.addEventListener('click', async () => {
  try{
    await bleSend('TAG_CLEAR_ALL', { all: true });
    tagSeq = 1;
    log('Cleared ALL tag roles + team assignments.');
  }catch(e){
    log(`TAG_CLEAR_ALL error: ${e.message}`);
  }
});

/* ---------- AUTO-RECONNECT ---------- */
function resetReconnect(){
  reconnectBackoffMs = 900;
  if(reconnectTimer){
    clearTimeout(reconnectTimer);
    reconnectTimer = null;
  }
}
function scheduleReconnect(reason){
  if(!autoReconnect.checked){
    setReconnectPill('OFF');
    return;
  }
  if(reconnectTimer) return;
  if(!device){
    setReconnectPill('‚Äî');
    return;
  }
  if(device.gatt?.connected) return;

  const wait = reconnectBackoffMs;
  reconnectBackoffMs = Math.min(Math.floor(reconnectBackoffMs * 1.7), reconnectBackoffMaxMs);

  setReconnectPill(`in ${Math.round(wait/100)/10}s`);
  log(`Auto-reconnect scheduled in ${Math.round(wait/100)/10}s (${reason})`);

  reconnectTimer = setTimeout(async () => {
    reconnectTimer = null;
    await tryReconnect(true);
  }, wait);
}

async function connectWithExistingDevice(label){
  setReconnectPill(label);
  server = await device.gatt.connect();
  service = await server.getPrimaryService(BLE.SERVICE_UUID);

  txChar = await service.getCharacteristic(BLE.TX_CHAR_UUID);
  rxChar = await service.getCharacteristic(BLE.RX_CHAR_UUID);

  try{
    await rxChar.startNotifications();
    rxChar.addEventListener('characteristicvaluechanged', (ev) => {
      const txt = new TextDecoder().decode(ev.target.value);
      log(`‚Üê ${txt}`);
      parseRx(txt);
    });
  }catch(e){
    log(`RX notifications not enabled: ${e.message}`);
  }

  setConnectedUI(true);
  log('Connected ‚úÖ');
  showToast('Connected ‚úÖ');
  vibrate([40,30,40]);
  resetReconnect();

  try{ await bleSend('PING'); }catch(_){}
}

async function tryReconnect(fromTimer){
  try{
    if(!autoReconnect.checked) return;
    if(!device) return;
    if(device.gatt?.connected) return;
    await connectWithExistingDevice(fromTimer ? 'auto' : 'reconnect');
  }catch(e){
    hadConnectFailure = true;
    log(`Reconnect error: ${e.message}`);
    setConnectedUI(false);
    scheduleReconnect('still disconnected');
  }
}

/**
 * Connect button turns WHITE + disabled when connected.
 * Disconnect button turns PURPLE when connected.
 */
function setConnectedUI(connected){
  connStatus.textContent = connected ? 'Connected' : 'Disconnected';
  connStatus.style.background = connected ? 'rgba(16,185,129,.12)' : 'var(--chip)';
  connStatus.style.borderColor = connected ? 'rgba(16,185,129,.25)' : 'rgba(99,91,255,.15)';
  connStatus.style.color = connected ? '#065f46' : 'var(--muted)';

  if(connected){
    btnConnect.className = 'secondary';
    btnConnect.disabled = true;

    btnDisconnect.className = 'accent';
    btnDisconnect.disabled = false;

    hideBanner();
    hadConnectFailure = false;

    if(autoReconnect.checked) setReconnectPill('‚Äî');
    else setReconnectPill('OFF');
  }else{
    btnConnect.className = 'accent';
    btnConnect.disabled = false;

    btnDisconnect.className = 'secondary';
    btnDisconnect.disabled = true;

    if(hadConnectFailure){
      if(!bleBanner.innerHTML){
        showBanner(`<strong>Connection failed</strong><br>Try again.`);
      }
    }else{
      hideBanner();
    }
  }

  btnSendWifi.disabled = !connected;
  btnUploadProfile.disabled = !connected;
  btnStartGame.disabled = !connected;
  btnEndGame.disabled = !connected;

  btnScoreA.disabled = !connected || !!lastState.game_over;
  btnScoreB.disabled = !connected || !!lastState.game_over;

  btnAminus.disabled = !connected;
  btnAplus.disabled  = !connected;
  btnAset.disabled   = !connected;

  btnBminus.disabled = !connected;
  btnBplus.disabled  = !connected;
  btnBset.disabled   = !connected;

  btnCheckinManual.disabled = !connected;

  // Tag tools
  btnTagRegister.disabled = !connected;
  btnTagAssign.disabled = !connected;
  btnTagTap.disabled = !connected;
  btnTagClearTeams.disabled = !connected;
  btnTagClearAll.disabled = !connected;

  const webNfcSupported = ('NDEFReader' in window);
  btnNfcScan.disabled = !(connected && webNfcSupported);
  btnNfcStop.disabled = !nfcActive;

  if(!connected){
    setGameOverUI(!!lastState.game_over, lastState.winner || null, lastState.a ?? 0, lastState.b ?? 0);
  }
}

/* ---------- BLE CONNECT / DISCONNECT ---------- */
btnConnect.addEventListener('click', async () => {
  try{
    hideBanner();
    hadConnectFailure = false;

    log('Requesting BLE device‚Ä¶');
    device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [BLE.SERVICE_UUID] }],
      optionalServices: [BLE.SERVICE_UUID]
    });

    deviceNamePill.textContent = `Device: ${device.name || 'Unnamed'}`;

    device.addEventListener('gattserverdisconnected', () => {
      log('Disconnected.');
      vibrate([60]);
      setConnectedUI(false);
      if(nfcActive) stopNfcScan();
      scheduleReconnect('link dropped');
    });

    await connectWithExistingDevice('manual');
    rssiPill.textContent = 'RSSI: (not available in WebBLE)';

  }catch(err){
    hadConnectFailure = true;

    const msg = err?.message || String(err);
    log(`Connect error: ${msg}`);
    vibrate([120,40,120]);

    if(looksLikeBleBusy(msg)){
      showBanner(`
        <strong>BLE Busy</strong><br>
        PlayPUCK can only connect to <strong>one</strong> BLE app at a time.<br><br>
        <ul>
          <li>Disconnect in <strong>nRF Connect</strong></li>
          <li>Force-close nRF (swipe away)</li>
          <li>Toggle Bluetooth off/on</li>
          <li>Then press Connect again</li>
        </ul>
      `);
    }else{
      showBanner(`
        <strong>Connection failed</strong><br>
        If PlayPUCK doesn‚Äôt appear or won‚Äôt connect, it‚Äôs often still connected in another BLE app.<br><br>
        <ul>
          <li>Force-close any BLE apps (nRF Connect etc.)</li>
          <li>Toggle Bluetooth off/on</li>
          <li>Try Connect again</li>
        </ul>
      `);
    }

    setConnectedUI(false);
  }
});

btnDisconnect.addEventListener('click', async () => {
  try{
    resetReconnect();
    setReconnectPill(autoReconnect.checked ? '‚Äî' : 'OFF');

    if(device?.gatt?.connected) device.gatt.disconnect();
    vibrate([50,20,50]);
    setConnectedUI(false);
    if(nfcActive) stopNfcScan();
  }catch(e){
    log(`Disconnect error: ${e.message}`);
  }
});

document.addEventListener('visibilitychange', () => {
  if(document.visibilityState === 'visible' && autoReconnect.checked && device && !device.gatt?.connected){
    tryReconnect(false);
  }
});

/* ---------- STEP BUTTONS ---------- */
btnSendWifi.addEventListener('click', async () => {
  try{
    const ssid = wifiSsid.value.trim();
    const pass = wifiPass.value;
    if(!ssid) return log('Enter Wi-Fi SSID first.');
    await bleSend('WIFI', { ssid, pass });
  }catch(e){
    log(`Wi-Fi send error: ${e.message}`);
  }
});

btnUploadProfile.addEventListener('click', async () => {
  try{
    const payload = buildMatchPayload();
    await bleSend('PROFILE_SELECT', payload);
  }catch(e){
    log(`Upload error: ${e.message}`);
  }
});

btnStartGame.addEventListener('click', async () => {
  try{
    lastState.game_over = false;
    lastState.winner = null;
    setGameOverUI(false, null, lastState.a ?? 0, lastState.b ?? 0);
    persistLastState();
    await bleSend('START_GAME');
  }catch(e){
    log(`Start error: ${e.message}`);
  }
});

btnEndGame.addEventListener('click', async () => {
  try{
    await bleSend('END_GAME');
    showToast('Sent END_GAME');
  }catch(e){
    log(`End game error: ${e.message}`);
  }
});

// 5) Score game (NO LOCAL SCORE CHANGE)
btnScoreA.addEventListener('click', async () => {
  try{
    await bleSend('SCORE', { team: 'A', delta: 1 });
  }catch(e){
    log(`Score A error: ${e.message}`);
  }
});
btnScoreB.addEventListener('click', async () => {
  try{
    await bleSend('SCORE', { team: 'B', delta: 1 });
  }catch(e){
    log(`Score B error: ${e.message}`);
  }
});

// 6) Edit score (NO LOCAL SCORE CHANGE)
btnAminus.addEventListener('click', async () => {
  try{ await bleSend('SCORE', { team: 'A', delta: -1 }); }
  catch(e){ log(`A- error: ${e.message}`); }
});
btnAplus.addEventListener('click', async () => {
  try{ await bleSend('SCORE', { team: 'A', delta: 1 }); }
  catch(e){ log(`A+ error: ${e.message}`); }
});
btnAset.addEventListener('click', async () => {
  try{
    const v = Math.max(0, Math.floor(Number(setAVal.value || 0)));
    await bleSend('SCORE_SET', { team: 'A', value: v });
  }catch(e){ log(`A set error: ${e.message}`); }
});

btnBminus.addEventListener('click', async () => {
  try{ await bleSend('SCORE', { team: 'B', delta: -1 }); }
  catch(e){ log(`B- error: ${e.message}`); }
});
btnBplus.addEventListener('click', async () => {
  try{ await bleSend('SCORE', { team: 'B', delta: 1 }); }
  catch(e){ log(`B+ error: ${e.message}`); }
});
btnBset.addEventListener('click', async () => {
  try{
    const v = Math.max(0, Math.floor(Number(setBVal.value || 0)));
    await bleSend('SCORE_SET', { team: 'B', value: v });
  }catch(e){ log(`B set error: ${e.message}`); }
});

/* ---------- Boot ---------- */
renderSavedWifiDropdown('');
restoreLastState();
renderStateUI();

setConnectedUI(false);
setReconnectPill(autoReconnect.checked ? '‚Äî' : 'OFF');
log('Ready. Connect to a PlayPUCK to begin.');
</script>
</body>
</html>
