<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>PlayPUCK Remote</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">

<style>
/* --- PlayPUCK Brand Variables (Clean White Theme) --- */
:root {
  --bg: #F6F7FB;
  --card: #FFFFFF;
  --text: #0F1218;       /* Charcoal */
  --muted: #64748B;      /* Slate */
  --border: #E2E8F0;
  --shadow: 0 4px 20px rgba(0,0,0,0.05);

  /* Traffic Light System */
  --puck-green: #1CB860;
  --puck-amber: #F9CF25;
  --puck-red:   #E92020;
  --puck-charcoal: #0F1218;

  /* UI Components */
  --btn-primary: #0F1218;
  --btn-text: #FFFFFF;
  --chip-bg: #F1F5F9;
}

* { box-sizing: border-box; }
html, body { height: 100%; }

body {
  margin: 0;
  font-family: "Comfortaa", system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
}

/* ---- Header ---- */
header {
  background: #fff; position: sticky; top: 0; z-index: 50;
  border-bottom: 1px solid var(--border);
  box-shadow: 0 2px 10px rgba(0,0,0,0.03);
}
.header-title { padding: 16px; text-align: center; }
header h1 { margin: 0; font-size: 24px; font-weight: 700; color: var(--text); letter-spacing: -0.5px; }

/* Status Bar */
.status-bar {
  display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;
  padding: 0 14px 14px; background: #fff;
}
.status-item {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: var(--chip-bg); border: 1px solid var(--border);
  border-radius: 16px; padding: 8px 4px; min-height: 54px;
}
.status-label { font-size: 10px; text-transform: uppercase; color: var(--muted); font-weight: 700; margin-bottom: 2px; }
.status-val { font-size: 12px; font-weight: 800; color: var(--text); line-height: 1.1; word-wrap: break-word; }
.dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; background: var(--muted); }
.dot.on { background: var(--puck-green); box-shadow: 0 0 6px var(--puck-green); }

/* ---- Layout & Cards ---- */
main { padding: 20px 14px 40px; max-width: 760px; margin: 0 auto; }
.grid { display: grid; grid-template-columns: 1fr; gap: 16px; }

.card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 24px; box-shadow: var(--shadow); overflow: hidden;
}
.cardHeader {
  padding: 16px; display: flex; align-items: flex-start; justify-content: space-between; gap: 10px;
  border-bottom: 1px solid var(--border); background: #FAFAFA;
}
.cardHeader h2 { margin: 0; font-size: 16px; font-weight: 700; color: var(--text); }
.cardHeader p { margin: 4px 0 0; font-size: 13px; color: var(--muted); line-height: 1.4; }
.stepBadge {
  font-size: 12px; font-weight: 800; color: var(--puck-charcoal);
  background: var(--puck-amber); padding: 4px 10px; border-radius: 99px; min-width: 28px; text-align: center;
}
.cardBody { padding: 16px; }

/* ---- Inputs & Forms ---- */
.row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
.twoCol { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.threeCol { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

label { display: block; font-size: 12px; color: var(--muted); margin: 0 0 6px; font-weight: 700; }
input, select, textarea {
  width: 100%; padding: 12px 14px; font-size: 16px; border-radius: 12px;
  border: 1px solid var(--border); background: #fff; color: var(--text);
  outline: none; font-family: inherit; transition: border-color 0.2s;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--puck-green); box-shadow: 0 0 0 3px rgba(28,184,96,0.1);
}
textarea { min-height: 100px; resize: vertical; }

/* ---- Buttons ---- */
button {
  -webkit-tap-highlight-color: transparent; appearance: none; border: 0;
  border-radius: 99px; padding: 12px 20px; font-size: 15px; font-weight: 700;
  cursor: pointer; width: 100%; min-height: 48px;
  background: var(--btn-primary); color: var(--btn-text);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform .1s ease, opacity .2s ease;
  font-family: inherit;
}
button:active { transform: translateY(1px); }
button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

button.secondary { background: #fff; color: var(--text); border: 2px solid var(--border); box-shadow: none; }
button.accent { background: var(--puck-charcoal); color: #fff; }
button.good { background: var(--puck-green); color: #fff; }
button.warn { background: var(--puck-amber); color: #000; }
button.danger { background: var(--puck-red); color: #fff; }
button.iconBtn { width: auto; min-height: 36px; padding: 6px 12px; font-size: 13px; }

/* ---- Components ---- */
.pill {
  display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px;
  border-radius: 99px; background: var(--chip-bg); border: 1px solid var(--border);
  color: var(--muted); font-size: 12px; font-weight: 700;
}
.checkRow {
  display: flex; gap: 10px; align-items: center; padding: 12px;
  border: 1px solid var(--border); border-radius: 12px; background: #fff; cursor: pointer;
}
.checkRow input { width: 20px; height: 20px; margin: 0; accent-color: var(--puck-green); }
.bleBanner {
  display: none; margin-top: 12px; padding: 12px; border-radius: 12px;
  background: #FEF2F2; border: 1px solid #FECACA; color: var(--puck-red);
  font-size: 13px; line-height: 1.4;
}

/* ---- Input Device List (NEW) ---- */
.device-list { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
.device-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px; background: #fff; border: 1px solid var(--border); border-radius: 12px;
}
.device-mac { font-family: monospace; font-weight: 700; color: var(--text); }
.device-label { font-size: 11px; color: var(--muted); }

/* Scoreboard */
.scoreboard { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
.scoreTile {
  border: 1px solid var(--border); border-radius: 20px; padding: 16px;
  background: linear-gradient(180deg, #fff 0%, #F8FAFC 100%); text-align: center;
}
.scoreTile h3 { margin: 0; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
.scoreVal { margin-top: 6px; font-size: 42px; font-weight: 800; color: var(--text); letter-spacing: -1px; }

.infoRow { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
.infoChip {
  padding: 4px 10px; border-radius: 8px; background: var(--chip-bg); border: 1px solid var(--border);
  color: var(--muted); font-size: 11px; font-weight: 700;
}
.gameOver {
  display: none; margin-top: 12px; padding: 16px; border-radius: 16px;
  background: #FEF2F2; border: 2px solid var(--puck-red);
  color: var(--puck-red); text-align: center; font-weight: 800;
}
.log {
  font-family: monospace; font-size: 11px; background: #0F172A; color: #E2E8F0;
  border-radius: 12px; padding: 12px; max-height: 180px; overflow: auto; white-space: pre-wrap;
}
.toast {
  position: fixed; left: 50%; bottom: 30px; transform: translateX(-50%); z-index: 9999;
  display: none; align-items: center; gap: 10px; background: var(--puck-charcoal); color: #fff;
  border-radius: 99px; padding: 12px 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); pointer-events: none;
}
.toast.show { display: flex; animation: toastIn .2s ease-out; }
@keyframes toastIn { from{ transform: translateX(-50%) translateY(10px); opacity:0; } to{ transform: translateX(-50%) translateY(0); opacity:1; } }

@media (max-width: 480px) { .twoCol, .threeCol { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<header>
  <div class="header-title">
    <h1>PlayPUCK</h1>
  </div>
  <div class="status-bar">
    <div class="status-item">
      <span class="status-label">Role</span>
      <span id="roleDisplay" class="status-val">—</span>
    </div>
    <div class="status-item">
      <span class="status-label">State</span>
      <span id="stateDisplay" class="status-val">IDLE</span>
    </div>
    <div class="status-item">
      <span class="status-label">Status</span>
      <span class="status-val" style="display:flex;align-items:center;">
        <span id="connDot" class="dot"></span>
        <span id="connText">Offline</span>
      </span>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    
    <section class="card" id="cardConnect">
      <div class="cardHeader">
        <div>
          <h2>Connection</h2>
          <p>Connect to your PlayPUCK via Bluetooth.</p>
        </div>
        <div class="stepBadge">1</div>
      </div>
      <div class="cardBody">
        <div class="twoCol">
          <button id="btnConnect" class="accent">Connect</button>
          <button id="btnDisconnect" class="secondary" disabled>Disconnect</button>
        </div>
        <div id="bleBanner" class="bleBanner"></div>
        <div class="row" style="margin-top:12px;">
          <span class="pill" id="deviceNamePill">Device: —</span>
          <span class="pill" id="rssiPill">RSSI: —</span>
          <span class="pill" id="reconnectPill">Reconnect: —</span>
        </div>
        <div style="margin-top:12px;">
          <label class="checkRow">
            <input id="autoReconnect" type="checkbox" checked>
            <span>Auto-reconnect (Recommended)</span>
          </label>
        </div>
      </div>
    </section>

    <section class="card" id="cardWifi">
      <div class="cardHeader">
        <div>
          <h2>Wi-Fi Setup</h2>
          <p>Send credentials to the puck.</p>
        </div>
        <div class="stepBadge">2</div>
      </div>
      <div class="cardBody">
        <label>Saved Networks</label>
        <select id="savedWifi">
          <option value="" selected>— Select Saved —</option>
        </select>
        <div class="twoCol" style="margin-top:12px;">
          <div><label>SSID Name</label><input id="wifiSsid" placeholder="e.g. HomeWiFi"></div>
          <div><label>Password</label><input id="wifiPass" type="password" placeholder="••••••••"></div>
        </div>
        <div style="margin-top:10px;">
           <label class="checkRow">
              <input id="showWifiPass" type="checkbox">
              <span>Show password</span>
           </label>
        </div>
        <div class="twoCol" style="margin-top:16px;">
          <button id="btnSendWifi" class="good" disabled>Send to Puck</button>
          <button id="btnSaveWifi" class="secondary">Save Locally</button>
        </div>
        <div class="twoCol" style="margin-top:10px;">
           <button id="btnForgetWifi" class="warn">Forget SSID</button>
           <button id="btnClearWifi" class="danger">Clear All</button>
        </div>
      </div>
    </section>

    <section class="card" id="cardInputs">
      <div class="cardHeader">
        <div>
          <h2>Input Devices</h2>
          <p>Manage allowed Shelly/RF buttons.</p>
        </div>
        <div class="stepBadge">3</div>
      </div>
      <div class="cardBody">
        <div class="twoCol">
           <div>
             <label>Device MAC Address</label>
             <input id="inputMac" placeholder="AA:BB:CC:DD:EE:FF">
           </div>
           <div style="display:flex; align-items:flex-end;">
             <button id="btnAddMac" class="accent">Add Device</button>
           </div>
        </div>
        
        <label style="margin-top:16px;">Allowed Devices (Upload to Sync)</label>
        <div id="deviceList" class="device-list">
           <div class="pill" style="justify-content:center;">No devices added</div>
        </div>
        
        <div class="hint">
          Add MACs here, then press <b>Upload Profile</b> below to send the Allowlist to the Puck.
        </div>
      </div>
    </section>

    <section class="card" id="cardMatch">
      <div class="cardHeader">
        <div>
          <h2>Game Mode</h2>
          <p>Configure rules and profiles.</p>
        </div>
        <div class="stepBadge">4</div>
      </div>
      <div class="cardBody">
        <label>Sport</label>
        <select id="sportSelect" style="margin-bottom:12px;">
            <option value="PICKLEBALL" selected>Pickleball</option>
            <option value="TENNIS">Tennis</option>
            <option value="BADMINTON">Badminton</option>
        </select>
        <div class="twoCol">
          <div>
            <label>Format</label>
            <select id="matchType">
              <option value="DOUBLES" selected>DOUBLES</option>
              <option value="SINGLES">SINGLES</option>
            </select>
          </div>
          <div>
            <label>Scoring</label>
            <select id="scoringMode">
              <option value="SIDEOUT" selected>SIDEOUT</option>
              <option value="RALLY">RALLY</option>
            </select>
          </div>
        </div>
        <div class="twoCol" style="margin-top:12px;">
          <div>
            <label>Play to...</label>
            <select id="winPointsPreset">
              <option value="7">7 Points</option>
              <option value="11" selected>11 Points</option>
              <option value="15">15 Points</option>
              <option value="21">21 Points</option>
            </select>
          </div>
          <div>
            <label>Win Rule</label>
            <select id="winRule">
              <option value="SUDDEN_DEATH" selected>Sudden Death</option>
              <option value="TWO_CLEAR">Win by 2</option>
            </select>
          </div>
        </div>

        <button id="btnUploadProfile" class="accent" style="margin-top:16px;" disabled>Upload Profile (Rules + Devices)</button>
        
        <div style="margin-top:16px; border-top:1px solid var(--border); padding-top:10px;">
           <label>Advanced</label>
           <div class="twoCol">
              <input id="matchId" placeholder="Match ID (Optional)">
              <select id="customOverride">
                 <option value="OFF" selected>Override OFF</option>
                 <option value="ON">Override ON (Use JSON)</option>
              </select>
           </div>
           <textarea id="matchJson" style="margin-top:8px; display:none;" placeholder="JSON"></textarea>
        </div>
        
        <div class="twoCol" style="margin-top:10px;">
           <button id="btnApplyProfileMidMatch" class="warn" disabled>Apply Mid-Match</button>
           <button id="btnPauseToggle" class="secondary" disabled>Pause Game</button>
        </div>
        <div class="checkRow" style="margin-top:8px;">
            <input id="chkAutoPauseApply" type="checkbox">
            <span>Auto-pause on apply</span>
        </div>
      </div>
    </section>

    <section class="card" id="cardStart">
        <div class="cardHeader">
            <div>
                <h2>Match Control</h2>
                <p>Start or End the active session.</p>
            </div>
            <div class="stepBadge">5</div>
        </div>
        <div class="cardBody">
            <div class="twoCol">
                <button id="btnStartGame" class="good" disabled>Start Game</button>
                <button id="btnEndGame" class="danger" disabled>End Game</button>
            </div>
        </div>
    </section>

    <section class="card" id="cardScore">
      <div class="cardHeader">
        <div>
          <h2>Scoreboard</h2>
          <p>Live scoring and remote inputs.</p>
        </div>
        <div class="stepBadge">6</div>
      </div>
      <div class="cardBody">
        <div id="gameOverBanner" class="gameOver">
          GAME OVER<br>
          <span id="gameOverWinner" style="font-size:14px; color:#000;">—</span>
          <br><small id="gameOverSub">Final: —</small>
        </div>
        <div class="scoreboard">
          <div class="scoreTile">
            <h3>Team A</h3>
            <div id="scoreA" class="scoreVal">0</div>
          </div>
          <div class="scoreTile">
            <h3>Team B</h3>
            <div id="scoreB" class="scoreVal">0</div>
          </div>
        </div>
        <div class="twoCol" style="margin-top:12px;">
            <button id="btnScoreA" class="accent" disabled>+ Point A</button>
            <button id="btnScoreB" class="accent" disabled>+ Point B</button>
        </div>
        <button id="btnUndo" class="secondary" style="margin-top:12px;">Undo Last Action</button>
        <div class="infoRow">
            <span class="infoChip" id="infoServe">Serve: —</span>
            <span class="infoChip" id="infoServerNum">Server: —</span>
            <span class="infoChip" id="infoMode">Mode: —</span>
            <span class="infoChip" id="pausePill">Paused: OFF</span>
        </div>
      </div>
    </section>
    
    <section class="card" id="cardEdit">
      <div class="cardHeader">
        <div>
          <h2>Manual Edit</h2>
          <p>Correction override (Admin only).</p>
        </div>
        <div class="stepBadge">7</div>
      </div>
      <div class="cardBody">
        <div class="twoCol">
            <div>
                <label style="text-align:center;">Team A</label>
                <div class="twoCol">
                    <button id="btnAminus" class="secondary" disabled>−</button>
                    <button id="btnAplus" class="secondary" disabled>+</button>
                </div>
                <div style="display:flex; gap:6px; margin-top:8px;">
                    <input id="setAVal" type="number" value="0" style="text-align:center;">
                    <button id="btnAset" class="warn" style="width:auto;" disabled>Set</button>
                </div>
            </div>
            <div>
                <label style="text-align:center;">Team B</label>
                <div class="twoCol">
                    <button id="btnBminus" class="secondary" disabled>−</button>
                    <button id="btnBplus" class="secondary" disabled>+</button>
                </div>
                <div style="display:flex; gap:6px; margin-top:8px;">
                    <input id="setBVal" type="number" value="0" style="text-align:center;">
                    <button id="btnBset" class="warn" style="width:auto;" disabled>Set</button>
                </div>
            </div>
        </div>
      </div>
    </section>

    <section class="card" id="cardCheckin">
      <div class="cardHeader">
        <div>
            <h2>NFC & Tags</h2>
            <p>Register players and hardware tags.</p>
        </div>
        <div class="stepBadge">8</div>
      </div>
      <div class="cardBody">
        <div class="twoCol">
            <button id="btnNfcScan" class="accent" disabled>Scan NFC</button>
            <button id="btnNfcStop" class="secondary" disabled>Stop</button>
        </div>
        <div id="nfcStatus" class="pill" style="margin-top:10px; width:100%; justify-content:center;">NFC Idle</div>
        
        <div style="margin-top:16px;">
            <label>Manual Player ID</label>
            <div style="display:flex; gap:8px;">
                <input id="checkinPlayerId" placeholder="e.g. P1234">
                <button id="btnCheckinManual" class="good" style="width:auto;" disabled>Check-In</button>
            </div>
        </div>

        <hr style="border:0; border-top:1px solid var(--border); margin:16px 0;">

        <label>Tag Registration</label>
        <div class="twoCol">
            <input id="tagUid" placeholder="Tag UID">
            <select id="tagRole">
                <option value="PLAYER">Player</option>
                <option value="ADMIN">Admin</option>
                <option value="REF">Ref</option>
            </select>
        </div>
        <div class="twoCol" style="margin-top:10px;">
             <button id="btnTagRegister" class="accent" disabled>Register Role</button>
             <button id="btnTagTap" class="good" disabled>Simulate Tap</button>
        </div>

        <label style="margin-top:16px;">Team Assignment</label>
        <div style="display:flex; gap:8px;">
            <select id="tagTeam">
                <option value="A">Team A</option>
                <option value="B">Team B</option>
                <option value="NONE">None</option>
            </select>
            <button id="btnTagAssign" class="secondary" style="width:auto;" disabled>Assign</button>
        </div>

        <div class="twoCol" style="margin-top:16px;">
            <button id="btnTagClearTeams" class="warn" disabled>Clear Teams</button>
            <button id="btnTagClearAll" class="danger" disabled>Reset All Tags</button>
        </div>
      </div>
    </section>

    <section class="card">
        <div class="cardHeader"><h2>Debug Log</h2></div>
        <div class="cardBody"><div id="log" class="log"></div></div>
    </section>
  </div>
</main>

<div id="toast" class="toast"><span id="toastText">Action Successful</span></div>

<script>
/* PlayPUCK Web Portal - Merged & Updated Logic */
const el = (id) => document.getElementById(id);
const logEl = el('log');
function log(msg) { logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + logEl.textContent; }
function showToast(t) { el('toastText').textContent = t; el('toast').classList.add('show'); setTimeout(()=>el('toast').classList.remove('show'),1300); }
function vibrate(p) { try { if (navigator.vibrate) navigator.vibrate(p); } catch (_) {} }

/* --- VARIABLES & STATE --- */
const BLE = { SERVICE_UUID: 0xFFFF, TX_CHAR: '0000ff01-0000-1000-8000-00805f9b34fb', RX_CHAR: '0000ff02-0000-1000-8000-00805f9b34fb' };
let device, txChar, rxChar;
let lastState = { a:0, b:0, game_over:false, paused:false, rules:{} };
let allowedMacs = []; // Local mirror for Step 3
let ndef = null;
let nfcActive = false;
let reconnectTimer = null;
let reconnectBackoffMs = 900;
const reconnectBackoffMaxMs = 12000;
let hadConnectFailure = false;

/* --- INPUT DEVICE LIST (NEW) --- */
function renderDeviceList() {
    const list = el('deviceList');
    list.innerHTML = '';
    if(allowedMacs.length === 0) {
        list.innerHTML = '<div class="pill" style="justify-content:center;">No devices added</div>';
        return;
    }
    allowedMacs.forEach(mac => {
        const div = document.createElement('div');
        div.className = 'device-item';
        div.innerHTML = `
            <div><div class="device-mac">${mac}</div><div class="device-label">Shelly/RF Button</div></div>
            <button class="iconBtn danger" onclick="removeMac('${mac}')">X</button>
        `;
        list.appendChild(div);
    });
}
window.removeMac = function(mac) {
    allowedMacs = allowedMacs.filter(m => m !== mac);
    renderDeviceList();
}
el('btnAddMac').addEventListener('click', () => {
    const val = el('inputMac').value.trim().toUpperCase();
    if(val.length < 5) return showToast('Invalid MAC');
    if(!allowedMacs.includes(val)) { allowedMacs.push(val); renderDeviceList(); el('inputMac').value=''; }
});

/* --- PROFILE BUILDER (Includes Allowed Macs) --- */
function buildMatchPayload() {
    if (el('customOverride').value === "ON") {
        try { return JSON.parse(el('matchJson').value); } catch(e){ log('Invalid JSON'); return {}; }
    }
    const rules = {
      target: Number(el('winPointsPreset').value),
      win_by: (el('winRule').value === "SUDDEN_DEATH") ? 0 : 2,
      format: el('matchType').value,
      scoring: el('scoringMode').value,
      allowed_button_macs: allowedMacs // Sync allowlist to puck
    };
    const payload = { sport: el('sportSelect').value, rules: rules };
    if(el('matchId').value) payload.match_id = el('matchId').value;
    return payload;
}

function syncJsonPreview(){
   if(el('customOverride').value === 'OFF') {
     try{ el('matchJson').value = JSON.stringify(buildMatchPayload(), null, 2); }catch(_){}
     el('matchJson').style.display = 'none';
   } else {
     el('matchJson').style.display = 'block';
   }
}
[el('matchType'), el('scoringMode'), el('winPointsPreset'), el('winRule'), el('customOverride'), el('matchId')].forEach(x => x.addEventListener('change', syncJsonPreview));

/* --- BLE LOGIC --- */
async function connectBle() {
  try {
    device = await navigator.bluetooth.requestDevice({ acceptAllDevices:true, optionalServices:[BLE.SERVICE_UUID] });
    el('deviceNamePill').textContent = device.name;
    device.addEventListener('gattserverdisconnected', onDisconnected);
    await performConnect();
  } catch(e) { log(e.message); }
}

async function performConnect() {
    try {
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(BLE.SERVICE_UUID);
        txChar = await service.getCharacteristic(BLE.TX_CHAR);
        rxChar = await service.getCharacteristic(BLE.RX_CHAR);
        await rxChar.startNotifications();
        rxChar.addEventListener('characteristicvaluechanged', (e) => onBleRx(new TextDecoder().decode(e.target.value)));
        
        el('connText').textContent = 'Online'; el('connDot').classList.add('on');
        el('btnConnect').disabled = true; el('btnDisconnect').disabled = false;
        
        // Enable controls
        const btns = ['btnSendWifi','btnUploadProfile','btnStartGame','btnScoreA','btnScoreB','btnUndo','btnPauseToggle','btnApplyProfileMidMatch','btnCheckinManual','btnTagRegister','btnTagAssign','btnTagClearTeams','btnTagClearAll'];
        btns.forEach(id => { if(el(id)) el(id).disabled=false; });
        if('NDEFReader' in window) el('btnNfcScan').disabled = false;

        showToast('Connected');
        resetReconnect();
        await bleSend('GET_STATE'); 
    } catch(e) { 
        log('Connect failed: ' + e.message); 
        onDisconnected();
    }
}

function onDisconnected() {
    el('connText').textContent = 'Offline'; el('connDot').classList.remove('on');
    el('btnConnect').disabled = false; el('btnDisconnect').disabled = true;
    if(el('autoReconnect').checked) scheduleReconnect();
}

function resetReconnect(){ reconnectBackoffMs = 900; if(reconnectTimer) clearTimeout(reconnectTimer); reconnectTimer=null; el('reconnectPill').textContent='Reconnect: —'; }

function scheduleReconnect(){
    if(reconnectTimer) return;
    const wait = reconnectBackoffMs;
    reconnectBackoffMs = Math.min(Math.floor(reconnectBackoffMs * 1.5), reconnectBackoffMaxMs);
    el('reconnectPill').textContent = `Retry in ${Math.round(wait/100)/10}s`;
    reconnectTimer = setTimeout(async () => {
        reconnectTimer = null;
        if(device && !device.gatt.connected) await performConnect();
    }, wait);
}

async function bleSend(cmd, payload={}) {
    if(!txChar) return;
    if(cmd === 'ACTION') { cmd='INPUT'; payload={ kind:'WEB_CLICK', source:'WEB', seq:Date.now(), ts_ms:Date.now(), payload:payload }; }
    const pkt = `${cmd} ${JSON.stringify(payload)}\n`;
    const enc = new TextEncoder().encode(pkt);
    for(let i=0; i<enc.length; i+=20) await txChar.writeValue(enc.slice(i, i+20));
    console.log('->', pkt);
}

let rxBuf = "";
function onBleRx(chunk) {
    rxBuf += chunk;
    if(rxBuf.includes('\n')) {
        const lines = rxBuf.split('\n');
        rxBuf = lines.pop(); 
        lines.forEach(processFrame);
    }
}

function processFrame(line) {
    try {
        const sp = line.indexOf(' ');
        const cmd = sp > 0 ? line.slice(0,sp) : line;
        const body = sp > 0 ? JSON.parse(line.slice(sp+1)) : {};
        if(cmd === 'STATE' || cmd === 'GET_STATE') {
            const s = body.sport_state || body;
            lastState = s;
            updateUI(s);
            // Sync Allowlist from Puck Rules
            if(s.rules && s.rules.allowed_button_macs) {
                const remote = s.rules.allowed_button_macs;
                let changed = false;
                remote.forEach(m => { if(!allowedMacs.includes(m)) { allowedMacs.push(m); changed=true; } });
                if(changed) renderDeviceList();
            }
        }
        if(cmd === 'GAME_OVER') {
             lastState.game_over = true;
             lastState.winner = body.winner || body.payload?.winner; // handle both formats
             updateUI(lastState);
             showToast('Game Over');
        }
    } catch(e) { console.log('Parse err', e); }
}

function updateUI(s) {
    const mode = el('sportSelect').value;
    
    // Tennis Logic from original
    if (mode === "TENNIS") {
        const tennisScores = ["0", "15", "30", "40", "GM"];
        el('scoreA').innerText = tennisScores[Math.min(s.a||0, 4)] || s.a;
        el('scoreB').innerText = tennisScores[Math.min(s.b||0, 4)] || s.b;
    } else {
        el('scoreA').innerText = s.a || 0;
        el('scoreB').innerText = s.b || 0;
    }
    
    // Pause / Game Over logic
    if (s.game_over) {
        el('stateDisplay').innerText = "GAME OVER";
        el('stateDisplay').style.color = "red";
        el('gameOverBanner').style.display = 'block';
        el('gameOverWinner').innerText = s.winner || '-';
        el('gameOverSub').innerText = `Final: A ${s.a} - ${s.b} B`;
    } else {
        el('stateDisplay').innerText = s.paused ? "PAUSED" : "ACTIVE";
        el('stateDisplay').style.color = "inherit";
        el('gameOverBanner').style.display = 'none';
    }
    
    // Info chips
    el('infoServe').innerText = `Serve: ${s.server_team!=null?s.server_team:'-'}`;
    el('infoServerNum').innerText = `Server: ${s.server_num!=null?s.server_num:'-'}`;
    el('infoMode').innerText = `Mode: ${s.mode||'-'}`;
    el('pausePill').innerText = `Paused: ${s.paused?'ON':'OFF'}`;
    
    // Button state for mid-match
    el('btnPauseToggle').innerText = s.paused ? "Resume Game" : "Pause Game";
    el('btnPauseToggle').className = s.paused ? "good" : "secondary";
}

/* --- NFC LOGIC (Restored Full Parsing) --- */
el('btnNfcScan').onclick = async () => {
    if(!txChar) return showToast('Connect BLE first');
    if('NDEFReader' in window) {
        try {
            ndef = new NDEFReader(); await ndef.scan();
            el('nfcStatus').textContent = 'Tap Tag Now...';
            el('btnNfcStop').disabled = false;
            el('btnNfcScan').disabled = true;
            nfcActive = true;
            
            ndef.onreading = ({serialNumber, message}) => {
                let pid = null;
                // Try reading text records (Advanced)
                for (const record of message.records) {
                    const dec = new TextDecoder(record.encoding || 'utf-8');
                    const txt = dec.decode(record.data);
                    if (record.recordType === 'text') pid = txt; 
                    else if (record.recordType === 'url') pid = txt; // simplified url extraction
                    if(pid) break;
                }
                // Fallback to serial
                if(!pid) pid = serialNumber;
                
                el('tagUid').value = pid;
                el('checkinPlayerId').value = pid;
                el('btnCheckinManual').disabled = false;
                el('nfcStatus').textContent = `Read: ${pid}`;
                bleSend('CHECKIN', {player_id:pid});
                showToast('Tag Scanned');
            };
        } catch(e) { el('nfcStatus').textContent = e.message; }
    } else el('nfcStatus').textContent = 'Web NFC not supported';
};
el('btnNfcStop').onclick = () => { nfcActive=false; el('btnNfcStop').disabled=true; el('btnNfcScan').disabled=false; };

/* --- EVENT LISTENERS --- */
el('btnConnect').onclick = connectBle;
el('btnDisconnect').onclick = () => { if(device) device.gatt.disconnect(); };
el('btnSendWifi').onclick = () => {
    const ssid = el('wifiSsid').value, pass = el('wifiPass').value;
    if(ssid) bleSend('WIFI', {ssid, pass}); showToast('Sent WiFi');
};
el('btnUploadProfile').onclick = async () => {
    await bleSend('PROFILE_SELECT', buildMatchPayload());
    showToast('Profile Uploaded');
};
el('btnStartGame').onclick = () => bleSend('START_GAME');
el('btnEndGame').onclick = () => bleSend('END_GAME');
el('btnScoreA').onclick = () => bleSend('ACTION', {action:'SCORE_A'});
el('btnScoreB').onclick = () => bleSend('ACTION', {action:'SCORE_B'});
el('btnUndo').onclick = () => bleSend('ACTION', {action:'UNDO'});

// Mid-match apply logic
el('btnApplyProfileMidMatch').onclick = async () => {
    const pause = el('chkAutoPauseApply').checked;
    if(pause && !lastState.paused) await bleSend('ACTION', {action:'PAUSE_GAME'});
    await bleSend('PROFILE_SELECT', buildMatchPayload());
    showToast('Rules Updated');
    if(pause) setTimeout(()=>bleSend('ACTION', {action:'RESUME_GAME'}), 500);
};

// Checkin Manual
el('btnCheckinManual').onclick = () => bleSend('CHECKIN', {player_id: el('checkinPlayerId').value});

// Tag Tools
el('btnTagRegister').onclick = () => bleSend('TAG_REGISTER', {uid:el('tagUid').value, role:el('tagRole').value});
el('btnTagAssign').onclick = () => bleSend('TAG_ASSIGN', {uid:el('tagUid').value, team:el('tagTeam').value});
el('btnTagTap').onclick = () => bleSend('TAG_TAP', {uid:el('tagUid').value, seq: Date.now()});
el('btnTagClearTeams').onclick = () => bleSend('TAG_CLEAR_TEAMS', {all:true});
el('btnTagClearAll').onclick = () => bleSend('TAG_CLEAR_ALL', {all:true});

// Wifi Storage
const LS_WIFI = 'playpuck_wifi';
function loadWifi() {
    const saved = JSON.parse(localStorage.getItem(LS_WIFI)||'[]');
    const sel = el('savedWifi'); sel.innerHTML='<option value="">— Select Saved —</option>';
    saved.forEach(w => { const o = document.createElement('option'); o.value=w.ssid; o.text=w.ssid; sel.appendChild(o); });
}
el('btnSaveWifi').onclick = () => {
    const saved = JSON.parse(localStorage.getItem(LS_WIFI)||'[]');
    saved.push({ssid:el('wifiSsid').value, pass:el('wifiPass').value});
    localStorage.setItem(LS_WIFI, JSON.stringify(saved));
    loadWifi(); showToast('Saved');
};
el('savedWifi').onchange = (e) => {
    const saved = JSON.parse(localStorage.getItem(LS_WIFI)||'[]');
    const f = saved.find(x=>x.ssid===e.target.value);
    if(f) { el('wifiSsid').value=f.ssid; el('wifiPass').value=f.pass; }
};

/* Init */
loadWifi();
renderDeviceList();
syncJsonPreview();
</script>
</body>
</html>
