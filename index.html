<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PlayPUCK Remote (BLE)</title>

  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --text: rgba(255,255,255,.92);
      --accent: #6366f1;   /* indigo */
      --accent2: #22c55e;  /* green */
      --danger: #ef4444;   /* red */
      --warning: #f59e0b;  /* amber */
      --chip: rgba(99,102,241,.14);
      --shadow: 0 14px 30px rgba(0,0,0,.40);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(99,102,241,.20), transparent 60%),
        radial-gradient(800px 600px at 90% 30%, rgba(16,185,129,.16), transparent 60%),
        radial-gradient(900px 700px at 40% 90%, rgba(236,72,153,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
    }

    header{
      position: sticky;
      top:0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: rgba(11,16,32,.60);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 18px 18px 70px;
    }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 0;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .logo{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(99,102,241,1), rgba(16,185,129,1));
      box-shadow: 0 12px 24px rgba(0,0,0,.28);
    }
    h1{
      font-size: 18px;
      margin:0;
      letter-spacing: .2px;
      font-weight: 700;
    }
    .sub{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 1px;
    }

    .pillRow{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .pill{
      font-size: 12px;
      color: var(--muted);
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .dot{
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9ca3af;
      box-shadow: 0 0 0 4px rgba(156,163,175,.12);
    }
    .dot.ok{
      background: #10b981;
      box-shadow: 0 0 0 4px rgba(16,185,129,.12);
    }
    .dot.bad{
      background: #ef4444;
      box-shadow: 0 0 0 4px rgba(239,68,68,.12);
    }

    .btnRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    button{
      font-family: inherit;
      border: none;
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 650;
      letter-spacing: .2px;
      color: white;
      transition: transform .05s ease, background .2s ease, opacity .2s ease;
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
    }
    button:active{ transform: translateY(1px); }
    button[disabled]{ opacity: .45; cursor: not-allowed; box-shadow:none; }
    .accent{ background: var(--accent); }
    .secondary{ background: rgba(255,255,255,.12); color: rgba(255,255,255,.88); border: 1px solid rgba(255,255,255,.14); }
    .good{ background: #10b981; }
    .danger{ background: #ef4444; }
    .warn{ background: #f59e0b; color: #111827; }

    main{ padding-top: 18px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media(min-width: 980px){
      .grid{
        grid-template-columns: 1.25fr .75fr;
        align-items:start;
      }
    }

    .card{
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px 16px;
      display:flex;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .cardHeader h2{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .cardHeader p{
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.25rem;
    }
    .stepBadge{
      font-family: var(--mono);
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(99,102,241,.12);
      border: 1px solid rgba(99,102,241,.24);
      color: rgba(255,255,255,.88);
      height: fit-content;
      white-space: nowrap;
    }
    .cardBody{ padding: 14px 16px 16px; }

    label{
      font-size: 12px;
      color: var(--muted2);
      display:block;
      margin: 10px 0 6px;
    }
    input, select, textarea{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      font-size: 13px;
      outline: none;
    }
    textarea{
      min-height: 90px;
      resize: vertical;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.25rem;
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media(min-width: 540px){
      .twoCol{ grid-template-columns: 1fr 1fr; }
    }

    .hint{
      margin-top: 10px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.25rem;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(99,102,241,.10);
      border: 1px solid rgba(99,102,241,.22);
      color: rgba(255,255,255,.88);
      font-family: var(--mono);
      font-size: 11px;
      margin-right: 6px;
      margin-top: 6px;
      white-space: nowrap;
    }

    .banner{
      display:none;
      margin-top: 10px;
      background: rgba(239,68,68,.12);
      border: 1px solid rgba(239,68,68,.28);
      color: rgba(255,255,255,.92);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 12px;
      line-height: 1.35rem;
    }
    .banner.show{ display:block; }

    .scoreboard{
      display:flex;
      justify-content:space-between;
      align-items:stretch;
      gap: 10px;
      margin-top: 10px;
    }
    .scoreBox{
      flex:1;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      padding: 12px 12px;
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-height: 86px;
    }
    .scoreBox .team{
      font-size: 12px;
      color: var(--muted2);
      letter-spacing: .2px;
    }
    .scoreBox .score{
      font-size: 42px;
      font-family: var(--mono);
      font-weight: 700;
      line-height: 1;
      margin-top: 6px;
    }
    .scoreBox .serve{
      font-size: 12px;
      color: var(--muted);
      margin-top: auto;
    }

    .gameOver{
      display:none;
      margin-top: 10px;
      border-radius: 16px;
      background: rgba(16,185,129,.12);
      border: 1px solid rgba(16,185,129,.26);
      padding: 12px 12px;
      font-weight: 800;
      letter-spacing: .3px;
    }
    .gameOver.show{ display:block; }
    .gameOver small{
      display:block;
      margin-top: 4px;
      color: rgba(255,255,255,.78);
      font-weight: 650;
      letter-spacing: .1px;
    }

    .logToolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .logToolbar .left{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .log{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.30);
      padding: 12px 12px;
      height: 320px;
      overflow:auto;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.25rem;
      white-space: pre-wrap;
    }

    .summary{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media(min-width: 540px){
      .summary{ grid-template-columns: 1fr 1fr; }
    }
    .k{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      padding: 10px 12px;
    }
    .k .t{
      font-size: 12px;
      color: var(--muted2);
    }
    .k .v{
      margin-top: 6px;
      font-family: var(--mono);
      font-size: 14px;
      font-weight: 700;
    }

    .nfcStatus{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.88);
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topRow">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>PlayPUCK Remote</h1>
          <div class="sub">Web BLE control panel (no app) • best in Chrome/Edge</div>
        </div>
      </div>

      <div>
        <div class="pillRow">
          <div class="pill"><span class="dot bad" id="dotBle"></span><span id="connStatus">Disconnected</span></div>
          <div class="pill" id="deviceNamePill">Device: —</div>
          <div class="pill" id="reconnectPill">Reconnect: —</div>
        </div>

        <div class="btnRow" style="margin-top:10px;">
          <button class="accent" id="btnConnect">Connect</button>
          <button class="secondary" id="btnDisconnect" disabled>Disconnect</button>
          <button class="secondary" id="btnClearLog">Clear log</button>
        </div>
      </div>
    </div>

    <div class="banner" id="bleBanner"></div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">
      <div>
        <!-- 1) WIFI -->
        <section class="card" id="cardWifi">
          <div class="cardHeader">
            <div>
              <h2>Wi-Fi setup</h2>
              <p>Send SSID/password/timezone to the PlayPUCK.</p>
            </div>
            <div class="stepBadge">1</div>
          </div>
          <div class="cardBody">
            <div class="twoCol">
              <div>
                <label for="ssid">SSID</label>
                <input id="ssid" placeholder="Wi-Fi name">
              </div>
              <div>
                <label for="pass">Password</label>
                <input id="pass" placeholder="Wi-Fi password">
              </div>
            </div>
            <div class="twoCol" style="margin-top:10px;">
              <div>
                <label for="tz">Timezone</label>
                <input id="tz" placeholder="e.g. Europe/London" value="Europe/London">
              </div>
              <div style="display:flex; align-items:end;">
                <button id="btnSendWifi" class="accent" disabled style="width:100%;">Send Wi-Fi</button>
              </div>
            </div>
            <div class="hint">Command: <span class="chip">WIFI {"ssid":"…","pass":"…","tz":"…"}</span></div>
          </div>
        </section>

        <!-- 2) MATCH / RULES (presets) -->
        <section class="card" id="cardMatch" style="margin-top:14px;">
          <div class="cardHeader">
            <div>
              <h2>Match selection</h2>
              <p>Pick a preset then upload it to the PlayPUCK.</p>
            </div>
            <div class="stepBadge">2</div>
          </div>
          <div class="cardBody">
            <div class="twoCol">
              <div>
                <label for="preset">Preset</label>
                <select id="preset">
                  <option value="D_SO_SD_11" selected>DOUBLES • SIDEOUT • SUDDEN DEATH • 11</option>
                  <option value="D_SO_SD_15">DOUBLES • SIDEOUT • SUDDEN DEATH • 15</option>
                  <option value="D_RL_SD_11">DOUBLES • RALLY • SUDDEN DEATH • 11</option>
                  <option value="S_SO_SD_11">SINGLES • SIDEOUT • SUDDEN DEATH • 11</option>
                  <option value="S_RL_SD_11">SINGLES • RALLY • SUDDEN DEATH • 11</option>
                </select>
              </div>
              <div>
                <label for="matchId">match_id (optional)</label>
                <input id="matchId" placeholder="e.g. m_12345">
              </div>
            </div>

            <div class="twoCol" style="margin-top:10px;">
              <div>
                <label for="customOverride">Custom override</label>
                <select id="customOverride">
                  <option value="OFF" selected>Use presets above</option>
                  <option value="ON">Override with JSON below</option>
                </select>
              </div>
              <div></div>
            </div>

            <div style="margin-top:10px;">
              <label for="matchJson">Match / Rules JSON</label>
              <textarea id="matchJson"
                placeholder='{"format":"DOUBLES","scoring":"SIDEOUT","win_points":11,"win_rule":"SUDDEN_DEATH"}'></textarea>
              <div class="hint">If override is ON, this JSON is uploaded exactly (plus match_id if provided).</div>
            </div>
          </div>
        </section>

        <!-- 2.5) NFC CHECK-IN -->
        <section class="card" id="cardCheckin" style="margin-top:14px;">
          <div class="cardHeader">
            <div>
              <h2>Player check-in (NFC → BLE)</h2>
              <p>Android Chrome/Edge only. Tap a tag to send <b>CHECKIN</b> to the PlayPUCK.</p>
            </div>
            <div class="stepBadge">2.5</div>
          </div>
          <div class="cardBody">
            <div class="twoCol">
              <button id="btnNfcScan" class="accent" disabled>Tap NFC to check in</button>
              <button id="btnNfcStop" class="secondary" disabled>Stop scan</button>
            </div>

            <div class="twoCol" style="margin-top:10px;">
              <div>
                <label for="checkinPlayerId">Manual player_id (test)</label>
                <input id="checkinPlayerId" placeholder="e.g. p1234 or UUID">
              </div>
              <div style="display:flex; align-items:end;">
                <button id="btnCheckinManual" class="secondary" disabled style="width:100%;">Send CHECKIN</button>
              </div>
            </div>

            <div class="hint">Command: <span class="chip">CHECKIN {"player_id":"…"}</span> (no scoring changes)</div>
            <div id="nfcStatus" class="nfcStatus">NFC idle.</div>
          </div>
        </section>

    <!-- 2.6) TAG TOOLS -->
    <section class="card" id="cardTags">
      <div class="cardHeader">
        <div>
          <h2>Tag tools (ROLE BINDINGS)</h2>
          <p>Register a tag’s <b>role</b> (persisted on the puck) and assign its <b>team</b> for this match (RAM). Then use TAG_TAP to score.</p>
        </div>
        <div class="stepBadge">2.6</div>
      </div>

      <div class="cardBody">
        <div class="twoCol">
          <div>
            <label for="tagUid">Tag UID (colon-hex)</label>
            <input id="tagUid" placeholder="e.g. 04:AA:BB:CC:DD:EE:FF">
          </div>
          <div>
            <label for="tagRole">Role (persisted)</label>
            <select id="tagRole">
              <option value="PLAYER" selected>PLAYER</option>
              <option value="ADMIN">ADMIN</option>
              <option value="REF">REF</option>
              <option value="NONE">NONE (unregister)</option>
            </select>
          </div>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <button id="btnTagRegister" class="accent" disabled>TAG_REGISTER (save role)</button>
          <button id="btnTagTap" class="good" disabled>TAG_TAP (score / check-in)</button>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <div>
            <label for="tagTeam">Team assignment (this match)</label>
            <select id="tagTeam">
              <option value="A" selected>Team A</option>
              <option value="B">Team B</option>
              <option value="NONE">NONE (remove assignment)</option>
            </select>
          </div>
          <div style="display:flex; align-items:end;">
            <button id="btnTagAssign" class="secondary" disabled style="width:100%;">TAG_ASSIGN (set team)</button>
          </div>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <button id="btnTagClearTeams" class="warn" disabled>Clear team assignments</button>
          <button id="btnTagClearAll" class="danger" disabled>Clear roles + teams</button>
        </div>

        <div class="hint" style="margin-top:10px;">
          Sends:
          <span class="chip">TAG_REGISTER {"uid":"…","role":"PLAYER"}</span>
          <span class="chip">TAG_ASSIGN {"uid":"…","team":"A"}</span>
          <span class="chip">TAG_TAP {"uid":"…","seq":1}</span>
          <span class="chip">TAG_CLEAR_TEAMS {"all":true}</span>
          <span class="chip">TAG_CLEAR_ALL {"all":true}</span>
        </div>
      </div>
    </section>


    <!-- 3) UPLOAD -->
        <section class="card" id="cardUpload" style="margin-top:14px;">
          <div class="cardHeader">
            <div>
              <h2>Upload to PlayPUCK</h2>
              <p>Send match profile to the PlayPUCK (PROFILE_SELECT).</p>
            </div>
            <div class="stepBadge">3</div>
          </div>
          <div class="cardBody">
            <button id="btnUploadProfile" class="accent" disabled style="width:100%;">Upload Profile</button>
            <div class="hint">Command: <span class="chip">PROFILE_SELECT {…}</span></div>
          </div>
        </section>

        <!-- 4) START GAME -->
        <section class="card" id="cardStart" style="margin-top:14px;">
          <div class="cardHeader">
            <div>
              <h2>Start game</h2>
              <p>Start/reset the game on the PlayPUCK.</p>
            </div>
            <div class="stepBadge">4</div>
          </div>
          <div class="cardBody">
            <button id="btnStartGame" class="good" disabled style="width:100%;">Start Game</button>
            <div class="hint">Command: <span class="chip">START_GAME</span></div>
          </div>
        </section>

        <!-- 5) SCORE -->
        <section class="card" id="cardScore" style="margin-top:14px;">
          <div class="cardHeader">
            <div>
              <h2>Score game</h2>
              <p>Send rally results (Team A or Team B won the rally). Puck applies the rules.</p>
            </div>
            <div class="stepBadge">5</div>
          </div>

          <div class="cardBody">

            <!-- GAME OVER banner -->
            <div id="gameOverBanner" class="gameOver">
              GAME OVER — <span id="gameOverWinner">—</span>
              <small id="gameOverSub">Final score: —</small>
            </div>

            <div class="scoreboard">
              <div class="scoreBox">
                <div class="team">Team A</div>
                <div class="score" id="scoreA">0</div>
                <div class="serve" id="serveA">—</div>
              </div>
              <div class="scoreBox">
                <div class="team">Team B</div>
                <div class="score" id="scoreB">0</div>
                <div class="serve" id="serveB">—</div>
              </div>
            </div>

            <div class="twoCol" style="margin-top:10px;">
              <button id="btnScoreA" class="accent" disabled>Team A won rally</button>
              <button id="btnScoreB" class="accent" disabled>Team B won rally</button>
            </div>

            <div class="hint">Command: <span class="chip">SCORE {"team":"A|B","delta":1}</span></div>
          </div>
        </section>

        <!-- 6) EDIT SCORE -->
        <section class="card" id="cardEdit" style="margin-top:14px;">
          <div class="cardHeader">
            <div>
              <h2>Edit score</h2>
              <p>Admin adjustments. Puck remains authoritative.</p>
            </div>
            <div class="stepBadge">6</div>
          </div>

          <div class="cardBody">
            <div class="twoCol">
              <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;">
                <button id="btnAminus" class="secondary" disabled>− A</button>
                <button id="btnAplus" class="secondary" disabled>+ A</button>
                <button id="btnAset" class="warn" disabled>Set A</button>
              </div>
              <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;">
                <button id="btnBminus" class="secondary" disabled>− B</button>
                <button id="btnBplus" class="secondary" disabled>+ B</button>
                <button id="btnBset" class="warn" disabled>Set B</button>
              </div>
            </div>

            <div class="twoCol" style="margin-top:10px;">
              <div>
                <label for="setAVal">Set Team A to…</label>
                <input id="setAVal" type="number" inputmode="numeric" min="0" step="1" value="0">
              </div>
              <div>
                <label for="setBVal">Set Team B to…</label>
                <input id="setBVal" type="number" inputmode="numeric" min="0" step="1" value="0">
              </div>
            </div>

            <div class="hint">
              Commands:
              <span class="chip">SCORE {"team":"A|B","delta":-1}</span>
              <span class="chip">SCORE_SET {"team":"A|B","value":n}</span>
            </div>
          </div>
        </section>

      </div>

      <!-- Right column: summary + log -->
      <div>

        <section class="card">
          <div class="cardHeader">
            <div>
              <h2>Live state</h2>
              <p>Updated from PlayPUCK <b>STATE</b> messages.</p>
            </div>
            <div class="stepBadge">STATE</div>
          </div>
          <div class="cardBody">
            <div class="summary">
              <div class="k">
                <div class="t">Profile</div>
                <div class="v" id="infoProfile">—</div>
              </div>
              <div class="k">
                <div class="t">Serve</div>
                <div class="v" id="infoServe">—</div>
              </div>
              <div class="k">
                <div class="t">Mode</div>
                <div class="v" id="infoMode">—</div>
              </div>
              <div class="k">
                <div class="t">Win rule</div>
                <div class="v" id="infoWin">—</div>
              </div>
            </div>

          </div>
        </section>

        <section class="card" style="margin-top:14px;">
          <div class="cardHeader">
            <div>
              <h2>Debug log</h2>
              <p>Messages sent/received.</p>
            </div>
            <div class="stepBadge">LOG</div>
          </div>
          <div class="cardBody">
            <div class="logToolbar">
              <div class="left">
                <div class="chip" id="rxCounter">RX: 0</div>
                <div class="chip" id="txCounter">TX: 0</div>
              </div>
              <div class="left">
                <div class="chip" id="logHint">Messages sent/received.</div>
              </div>
            </div>
          </div>
          <div class="log" id="log">LOG
</div>
        </section>
      </div>
    </div>
  </div>
</main>

<script>
/* ============================================================
   PLAYPUCK REMOTE — single-file UI
   BLE Service: 0000ffff-0000-1000-8000-00805f9b34fb
   TX(write):   0000ff01-0000-1000-8000-00805f9b34fb   (browser -> puck)
   RX(notify):  0000ff02-0000-1000-8000-00805f9b34fb   (puck -> browser)
============================================================ */

const BLE = {
  SERVICE_UUID: '0000ffff-0000-1000-8000-00805f9b34fb',
  TX_UUID:      '0000ff01-0000-1000-8000-00805f9b34fb',
  RX_UUID:      '0000ff02-0000-1000-8000-00805f9b34fb',
};

const el = (id) => document.getElementById(id);

// Header UI
const dotBle = el('dotBle');
const connStatus = el('connStatus');
const deviceNamePill = el('deviceNamePill');
const reconnectPill = el('reconnectPill');
const bleBanner = el('bleBanner');

const btnConnect = el('btnConnect');
const btnDisconnect = el('btnDisconnect');
const btnClearLog = el('btnClearLog');

// Controls
const ssid = el('ssid');
const pass = el('pass');
const tz = el('tz');
const btnSendWifi = el('btnSendWifi');

const preset = el('preset');
const matchId = el('matchId');
const customOverride = el('customOverride');
const matchJson = el('matchJson');

const btnUploadProfile = el('btnUploadProfile');
const btnStartGame = el('btnStartGame');

const btnScoreA = el('btnScoreA');
const btnScoreB = el('btnScoreB');

const btnAminus = el('btnAminus');
const btnAplus  = el('btnAplus');
const btnAset   = el('btnAset');

const btnBminus = el('btnBminus');
const btnBplus  = el('btnBplus');
const btnBset   = el('btnBset');

const scoreAEl = el('scoreA');
const scoreBEl = el('scoreB');

const setAVal = el('setAVal');
const setBVal = el('setBVal');

const btnNfcScan = el('btnNfcScan');
const btnNfcStop = el('btnNfcStop');
const nfcStatusEl = el('nfcStatus');
const checkinPlayerId = el('checkinPlayerId');
const btnCheckinManual = el('btnCheckinManual');

const tagUid = el('tagUid');
const tagRole = el('tagRole');
const tagTeam = el('tagTeam');
const btnTagRegister = el('btnTagRegister');
const btnTagAssign = el('btnTagAssign');
const btnTagTap = el('btnTagTap');
const btnTagClearTeams = el('btnTagClearTeams');
const btnTagClearAll = el('btnTagClearAll');

let tagSeq = 1;
function normUid(u){ return String(u || '').trim().toUpperCase(); }


// New UI bits
const gameOverBanner = el('gameOverBanner');
const gameOverWinner = el('gameOverWinner');
const gameOverSub = el('gameOverSub');
const infoServe = el('infoServe');
const infoMode = el('infoMode');
const infoProfile = el('infoProfile');
const infoWin = el('infoWin');

const logEl = el('log');
const rxCounterEl = el('rxCounter');
const txCounterEl = el('txCounter');

// State
let device = null;
let server = null;
let service = null;
let txChar = null;
let rxChar = null;

let rxCount = 0;
let txCount = 0;

let hadConnectFailure = false;

// lastState is used for UI enabling (game_over) + scoreboard text
let lastState = { a: 0, b: 0, serving: "A", mode: "SIDEOUT", format: "DOUBLES", win_points: 11, win_rule: "SUDDEN_DEATH", server_num: 2, game_over: false };

// NFC
let nfcReader = null;
let nfcActive = false;

// -------------------- LOGGING --------------------
function log(line){
  const ts = new Date().toLocaleTimeString();
  const msg = `[${ts}] ${line}`;
  logEl.textContent = (logEl.textContent + '\n' + msg).trim();
  logEl.scrollTop = logEl.scrollHeight;
}
function incRx(){ rxCount++; rxCounterEl.textContent = `RX: ${rxCount}`; }
function incTx(){ txCount++; txCounterEl.textContent = `TX: ${txCount}`; }

btnClearLog.addEventListener('click', () => {
  logEl.textContent = 'LOG';
  rxCount = 0; txCount = 0;
  rxCounterEl.textContent = 'RX: 0';
  txCounterEl.textContent = 'TX: 0';
});

// -------------------- UI helpers --------------------
function showBanner(html){
  bleBanner.innerHTML = html;
  bleBanner.classList.add('show');
}
function hideBanner(){
  bleBanner.innerHTML = '';
  bleBanner.classList.remove('show');
}
function setDot(connected){
  dotBle.classList.remove('ok','bad');
  if(connected){ dotBle.classList.add('ok'); }
  else{ dotBle.classList.add('bad'); }
}
function setReconnectPill(text){
  reconnectPill.textContent = `Reconnect: ${text}`;
}

function setGameOverUI(isOver, winner, a, b){
  if(isOver){
    gameOverBanner.classList.add('show');
    gameOverWinner.textContent = winner || '—';
    gameOverSub.textContent = `Final score: A ${a} — ${b} B`;
  }else{
    gameOverBanner.classList.remove('show');
    gameOverWinner.textContent = '—';
    gameOverSub.textContent = '—';
  }
}

function updateStateUI(){
  const a = lastState.a ?? 0;
  const b = lastState.b ?? 0;
  scoreAEl.textContent = a;
  scoreBEl.textContent = b;

  // Serve string
  let serve = lastState.serving || 'A';
  if(lastState.format === 'DOUBLES' && lastState.mode === 'SIDEOUT' && lastState.server_num){
    serve += ` (S${lastState.server_num})`;
  }
  infoServe.textContent = serve;

  infoMode.textContent = `${lastState.format || '—'} / ${lastState.mode || '—'}`;
  infoWin.textContent = `${lastState.win_rule || '—'} to ${lastState.win_points || '—'}`;

  // Compact profile label
  const f = (lastState.format || 'D').startsWith('S') ? 'S' : 'D';
  const m = (lastState.mode || 'SIDEOUT').startsWith('R') ? 'RL' : 'SO';
  const w = (lastState.win_rule || 'SUDDEN_DEATH').startsWith('T') ? 'W2' : 'SD';
  const t = lastState.win_points || 11;
  infoProfile.textContent = `${f}_${m}_${w}_${t}`;

  // Enable/disable rally buttons if game over
  btnScoreA.disabled = !txChar || !!lastState.game_over;
  btnScoreB.disabled = !txChar || !!lastState.game_over;

  // Show game-over banner if needed
  if(lastState.game_over){
    setGameOverUI(true, lastState.winner || (a > b ? 'A' : 'B'), a, b);
  }else{
    setGameOverUI(false, null, a, b);
  }
}

function setNfcStatus(text){
  nfcStatusEl.textContent = text;
}

// -------------------- PRESETS --------------------
const PRESETS = {
  D_SO_SD_11: { format:"DOUBLES", scoring:"SIDEOUT", win_points:11, win_rule:"SUDDEN_DEATH" },
  D_SO_SD_15: { format:"DOUBLES", scoring:"SIDEOUT", win_points:15, win_rule:"SUDDEN_DEATH" },
  D_RL_SD_11: { format:"DOUBLES", scoring:"RALLY",   win_points:11, win_rule:"SUDDEN_DEATH" },
  S_SO_SD_11: { format:"SINGLES", scoring:"SIDEOUT", win_points:11, win_rule:"SUDDEN_DEATH" },
  S_RL_SD_11: { format:"SINGLES", scoring:"RALLY",   win_points:11, win_rule:"SUDDEN_DEATH" },
};

function buildProfilePayload(){
  // Override mode
  if(String(customOverride.value || 'OFF') === 'ON'){
    let obj;
    try{
      obj = JSON.parse(matchJson.value || '{}');
    }catch(e){
      throw new Error(`Invalid JSON override: ${e.message}`);
    }
    if(matchId.value.trim()) obj.match_id = matchId.value.trim();
    return obj;
  }

  // Preset mode
  const p = PRESETS[preset.value] || PRESETS.D_SO_SD_11;
  const obj = { ...p };
  if(matchId.value.trim()) obj.match_id = matchId.value.trim();
  return obj;
}

// -------------------- BLE Helpers --------------------
function enc(s){ return new TextEncoder().encode(String(s)); }

async function bleSend(command, payloadObj=null){
  if(!txChar) throw new Error('Not connected / TX characteristic missing.');
  const payload = payloadObj ? JSON.stringify(payloadObj) : '';
  const line = payload ? `${command} ${payload}` : `${command}`;
  incTx();
  log(`→ ${line}`);
  await txChar.writeValue(enc(line));
}

// -------------------- BLE Connect/Disconnect --------------------
btnConnect.addEventListener('click', async () => {
  hideBanner();
  hadConnectFailure = false;

  try{
    setReconnectPill('—');

    device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [BLE.SERVICE_UUID] }],
      optionalServices: [BLE.SERVICE_UUID]
    });

    deviceNamePill.textContent = `Device: ${device.name || 'PlayPUCK'}`;

    device.addEventListener('gattserverdisconnected', () => {
      setConnectedUI(false);
      log('Disconnected ❌');
    });

    server = await device.gatt.connect();
    service = await server.getPrimaryService(BLE.SERVICE_UUID);

    txChar = await service.getCharacteristic(BLE.TX_UUID);
    rxChar = await service.getCharacteristic(BLE.RX_UUID);

    await rxChar.startNotifications();
    rxChar.addEventListener('characteristicvaluechanged', (e) => {
      incRx();
      const v = e.target.value;
      const msg = new TextDecoder().decode(v);
      log(`← ${msg}`);

      // Parse STATE / GAME_OVER if present
      if(msg.startsWith('STATE ')){
        try{
          const obj = JSON.parse(msg.slice(6));
          // Some firmwares include {reason:"..."} inside STATE; keep it if present
          lastState = { ...lastState, ...obj };
          updateStateUI();
        }catch(_){}
      }else if(msg.startsWith('GAME_OVER ')){
        try{
          const obj = JSON.parse(msg.slice(10));
          lastState.game_over = true;
          lastState.winner = obj.winner;
          lastState.a = obj.a;
          lastState.b = obj.b;
          updateStateUI();
        }catch(_){}
      }else{
        // Some variants send ACK STATE {"reason":"..."} (not JSON state)
        // No action required.
      }
    });

    setConnectedUI(true);
    log('Connected ✅');

    // Optional: some firmwares support PING; web remote doesn’t need a UI for it.
    // If the puck emits STATE on connect anyway, you're good.

  }catch(e){
    hadConnectFailure = true;
    setConnectedUI(false);
    showBanner(`<strong>Connection failed</strong><br>${e.message}`);
    log(`Connect error: ${e.message}`);
  }
});

btnDisconnect.addEventListener('click', async () => {
  try{
    if(device?.gatt?.connected) device.gatt.disconnect();
    setConnectedUI(false);
    if(nfcActive) stopNfcScan();
    log('Disconnected (manual)');
  }catch(e){
    log(`Disconnect error: ${e.message}`);
  }
});

// -------------------- Connection UI --------------------
function setConnectedUI(connected){
  connStatus.textContent = connected ? 'Connected' : 'Disconnected';
  setDot(connected);

  btnConnect.disabled = connected;
  btnDisconnect.disabled = !connected;

  btnSendWifi.disabled = !connected;
  btnUploadProfile.disabled = !connected;
  btnStartGame.disabled = !connected;

  // Rally buttons are only enabled when connected AND not game_over.
  btnScoreA.disabled = !connected || !!lastState.game_over;
  btnScoreB.disabled = !connected || !!lastState.game_over;

  btnAminus.disabled = !connected;
  btnAplus.disabled  = !connected;
  btnAset.disabled   = !connected;

  btnBminus.disabled = !connected;
  btnBplus.disabled  = !connected;
  btnBset.disabled   = !connected;

  btnCheckinManual.disabled = !connected;

  btnTagRegister.disabled = !connected;
  btnTagAssign.disabled   = !connected;
  btnTagTap.disabled      = !connected;
  btnTagClearTeams.disabled = !connected;
  btnTagClearAll.disabled   = !connected;

  const webNfcSupported = ('NDEFReader' in window);
  btnNfcScan.disabled = !connected || !webNfcSupported;
  btnNfcStop.disabled = !connected || !webNfcSupported || !nfcActive;
}

// -------------------- NFC helpers --------------------
function decodeRecordText(record){
  try{
    const dec = new TextDecoder(record.encoding || 'utf-8');
    return dec.decode(record.data);
  }catch(_){
    const dec = new TextDecoder('utf-8');
    return dec.decode(record.data);
  }
}
function tryExtractPlayerIdFromText(text){
  const t = String(text || '').trim();
  if(!t) return null;
  try{
    const obj = JSON.parse(t);
    if(obj && (obj.player_id || obj.pid)){
      return String(obj.player_id || obj.pid);
    }
  }catch(_){}
  // Fallback: use raw text as player_id (simple tags)
  return t;
}

async function sendCheckin(playerId){
  playerId = String(playerId || '').trim();
  if(!playerId){
    log('Check-in: player_id is empty.');
    setNfcStatus('Enter a player_id or tap a tag.');
    return;
  }
  try{
    await bleSend('CHECKIN', { player_id: playerId });
    setNfcStatus(`✅ Sent CHECKIN for: ${playerId}`);
  }catch(e){
    log(`Check-in send error: ${e.message}`);
    setNfcStatus(`❌ BLE send failed: ${e.message}`);
  }
}

btnCheckinManual.addEventListener('click', async () => {
  await sendCheckin(checkinPlayerId.value);
});

/* ---------- TAG TOOLS (ROLE BINDINGS) ---------- */
btnTagRegister.addEventListener('click', async () => {
  const uid = normUid(tagUid.value);
  const role = String(tagRole.value || '').trim();
  if(!uid){ log('TAG_REGISTER: enter a UID first.'); return; }
  try{
    await bleSend('TAG_REGISTER', { uid, role });
  }catch(e){
    log(`TAG_REGISTER error: ${e.message}`);
  }
});

btnTagAssign.addEventListener('click', async () => {
  const uid = normUid(tagUid.value);
  const team = String(tagTeam.value || '').trim(); // A|B|NONE
  if(!uid){ log('TAG_ASSIGN: enter a UID first.'); return; }
  try{
    await bleSend('TAG_ASSIGN', { uid, team });
  }catch(e){
    log(`TAG_ASSIGN error: ${e.message}`);
  }
});

btnTagTap.addEventListener('click', async () => {
  const uid = normUid(tagUid.value);
  if(!uid){ log('TAG_TAP: enter a UID first.'); return; }
  try{
    await bleSend('TAG_TAP', { uid, seq: tagSeq++ });
  }catch(e){
    log(`TAG_TAP error: ${e.message}`);
  }
});

btnTagClearTeams.addEventListener('click', async () => {
  try{
    await bleSend('TAG_CLEAR_TEAMS', { all: true });
    log('Cleared team assignments.');
  }catch(e){
    log(`TAG_CLEAR_TEAMS error: ${e.message}`);
  }
});

btnTagClearAll.addEventListener('click', async () => {
  try{
    await bleSend('TAG_CLEAR_ALL', { all: true });
    tagSeq = 1;
    log('Cleared ALL tag roles + team assignments.');
  }catch(e){
    log(`TAG_CLEAR_ALL error: ${e.message}`);
  }
});


btnNfcScan.addEventListener('click', async () => {
  if(!('NDEFReader' in window)){
    setNfcStatus('❌ Web NFC not supported on this browser/device.');
    return;
  }
  if(nfcActive) return;

  try{
    nfcReader = new NDEFReader();
    await nfcReader.scan();
    nfcActive = true;
    setNfcStatus('✅ NFC scanning… Tap a tag.');

    nfcReader.onreadingerror = () => {
      setNfcStatus('❌ NFC read error. Try again.');
    };

    nfcReader.onreading = async (event) => {
      // Prefer extracting from NDEF; if none, just show serialNumber
      let playerId = null;

      if(event && event.message && event.message.records && event.message.records.length){
        for(const rec of event.message.records){
          if(rec.recordType === 'text'){
            const text = decodeRecordText(rec);
            playerId = tryExtractPlayerIdFromText(text);
            break;
          }
        }
      }
      if(!playerId){
        // fallback: use serialNumber if present
        playerId = (event.serialNumber || '').trim();
      }

      if(!playerId){
        setNfcStatus('Tag read, but no usable player_id.');
        return;
      }

      await sendCheckin(playerId);
    };
  }catch(e){
    setNfcStatus(`❌ NFC scan failed: ${e.message}`);
    nfcActive = false;
    nfcReader = null;
  }finally{
    setConnectedUI(!!txChar);
  }
});

btnNfcStop.addEventListener('click', async () => {
  nfcActive = false;
  nfcReader = null;
  setNfcStatus('NFC stopped.');
  setConnectedUI(!!txChar);
});

function stopNfcScan(){
  nfcActive = false;
  nfcReader = null;
  setNfcStatus('NFC stopped.');
  setConnectedUI(!!txChar);
}

// -------------------- BUTTON actions --------------------
btnSendWifi.addEventListener('click', async () => {
  try{
    const payload = {
      ssid: String(ssid.value || ''),
      pass: String(pass.value || ''),
      tz:   String(tz.value || 'Europe/London'),
    };
    await bleSend('WIFI', payload);
  }catch(e){
    showBanner(`<strong>Wi-Fi send failed</strong><br>${e.message}`);
  }
});

btnUploadProfile.addEventListener('click', async () => {
  try{
    hideBanner();
    const payload = buildProfilePayload();
    await bleSend('PROFILE_SELECT', payload);
  }catch(e){
    showBanner(`<strong>Upload failed</strong><br>${e.message}`);
  }
});

btnStartGame.addEventListener('click', async () => {
  try{
    hideBanner();
    await bleSend('START_GAME');
  }catch(e){
    showBanner(`<strong>Start failed</strong><br>${e.message}`);
  }
});

btnScoreA.addEventListener('click', async () => {
  try{
    await bleSend('SCORE', { team:'A', delta: 1 });
  }catch(e){ showBanner(`<strong>SCORE failed</strong><br>${e.message}`); }
});

btnScoreB.addEventListener('click', async () => {
  try{
    await bleSend('SCORE', { team:'B', delta: 1 });
  }catch(e){ showBanner(`<strong>SCORE failed</strong><br>${e.message}`); }
});

btnAminus.addEventListener('click', async () => {
  try{ await bleSend('SCORE', { team:'A', delta:-1 }); }catch(e){}
});
btnAplus.addEventListener('click', async () => {
  try{ await bleSend('SCORE', { team:'A', delta:+1 }); }catch(e){}
});
btnAset.addEventListener('click', async () => {
  const v = Math.max(0, parseInt(setAVal.value || '0',10) || 0);
  try{ await bleSend('SCORE_SET', { team:'A', value:v }); }catch(e){}
});

btnBminus.addEventListener('click', async () => {
  try{ await bleSend('SCORE', { team:'B', delta:-1 }); }catch(e){}
});
btnBplus.addEventListener('click', async () => {
  try{ await bleSend('SCORE', { team:'B', delta:+1 }); }catch(e){}
});
btnBset.addEventListener('click', async () => {
  const v = Math.max(0, parseInt(setBVal.value || '0',10) || 0);
  try{ await bleSend('SCORE_SET', { team:'B', value:v }); }catch(e){}
});

// Initial
setConnectedUI(false);
setReconnectPill('—');
infoServe.textContent = '—';
infoMode.textContent = '—';
infoProfile.textContent = '—';
infoWin.textContent = '—';
log('Ready. Connect to a PlayPUCK to begin.');
</script>
</body>
</html>
