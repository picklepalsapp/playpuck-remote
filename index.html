<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>PlayPUCK Remote</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">

<style>
/* --- PlayPUCK Brand Variables (Light Theme) --- */
:root {
  /* Core Layout Colors */
  --bg: #F6F7FB;         /* Original light grey background */
  --card: #FFFFFF;       /* White cards */
  --text: #0F1218;       /* Brand 'Charcoal' for text */
  --muted: #64748B;      /* Slate grey for secondary text */
  --border: #E2E8F0;     /* Light borders */
  --shadow: 0 4px 20px rgba(0,0,0,0.05); /* Soft shadow */

  /* Brand Traffic Light Palette */
  --puck-green: #1CB860;
  --puck-amber: #F9CF25;
  --puck-red:   #E92020;
  --puck-charcoal: #0F1218;

  /* UI Elements */
  --btn-primary: #0F1218; /* Charcoal buttons (like original) */
  --btn-text: #FFFFFF;
  --chip-bg: #F1F5F9;
}

* { box-sizing: border-box; }
html, body { height: 100%; }

body {
  margin: 0;
  font-family: "Comfortaa", system-ui, sans-serif; /* Brand Font */
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
}

/* ---- Header ---- */
header {
  background: #fff;
  position: sticky;
  top: 0;
  z-index: 50;
  border-bottom: 1px solid var(--border);
  box-shadow: 0 2px 10px rgba(0,0,0,0.03);
}

.header-title {
  padding: 16px;
  text-align: center;
}

header h1 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -0.5px;
}
header p {
  margin: 2px 0 0;
  font-size: 13px;
  color: var(--muted);
}

/* Status Bar Grid (Preserved from Original) */
.status-bar {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
  padding: 0 14px 14px;
  background: #fff;
}
.status-item {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: var(--chip-bg);
  border: 1px solid var(--border);
  border-radius: 16px; /* Rounded corners */
  padding: 8px 4px;
  min-height: 54px;
}
.status-label { font-size: 10px; text-transform: uppercase; color: var(--muted); font-weight: 700; margin-bottom: 2px; }
.status-val { font-size: 12px; font-weight: 800; color: var(--text); line-height: 1.1; word-wrap: break-word; }

.dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; background: var(--muted); }
.dot.on { background: var(--puck-green); box-shadow: 0 0 6px var(--puck-green); }

/* ---- Layout & Cards ---- */
main {
  padding: 20px 14px 40px;
  max-width: 760px;
  margin: 0 auto;
}
.grid { display: grid; grid-template-columns: 1fr; gap: 16px; }

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 24px; /* Brand rounded look */
  box-shadow: var(--shadow);
  overflow: hidden;
}

.cardHeader {
  padding: 16px;
  display: flex; align-items: flex-start; justify-content: space-between; gap: 10px;
  border-bottom: 1px solid var(--border);
  background: #FAFAFA; /* Very subtle grey header */
}
.cardHeader h2 { margin: 0; font-size: 16px; font-weight: 700; color: var(--text); }
.cardHeader p { margin: 4px 0 0; font-size: 13px; color: var(--muted); line-height: 1.4; }

.stepBadge {
  font-size: 12px; font-weight: 800; color: var(--puck-charcoal);
  background: var(--puck-amber); /* Traffic light amber */
  padding: 4px 10px; border-radius: 99px; min-width: 28px; text-align: center;
}

.cardBody { padding: 16px; }

/* ---- Inputs & Forms ---- */
.row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
.twoCol { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.threeCol { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

label { display: block; font-size: 12px; color: var(--muted); margin: 0 0 6px; font-weight: 700; }

input, select, textarea {
  width: 100%; padding: 12px 14px; font-size: 16px; border-radius: 12px;
  border: 1px solid var(--border); background: #fff; color: var(--text);
  outline: none; font-family: inherit;
  transition: border-color 0.2s;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--puck-green);
  box-shadow: 0 0 0 3px rgba(28,184,96,0.1);
}
textarea { min-height: 100px; resize: vertical; }

/* ---- Buttons (Brand Pills) ---- */
button {
  -webkit-tap-highlight-color: transparent; appearance: none; border: 0;
  border-radius: 99px; /* Pill Shape */
  padding: 12px 20px; font-size: 15px; font-weight: 700;
  cursor: pointer; width: 100%; min-height: 48px;
  background: var(--btn-primary); color: var(--btn-text);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transition: transform .1s ease, opacity .2s ease;
  font-family: inherit;
}
button:active { transform: translateY(1px); }
button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

button.secondary { background: #fff; color: var(--text); border: 2px solid var(--border); box-shadow: none; }
button.accent { background: var(--puck-charcoal); color: #fff; } /* Primary Action */
button.good { background: var(--puck-green); color: #fff; }
button.warn { background: var(--puck-amber); color: #000; }
button.danger { background: var(--puck-red); color: #fff; }

/* ---- Components ---- */
.pill {
  display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px;
  border-radius: 99px; background: var(--chip-bg); border: 1px solid var(--border);
  color: var(--muted); font-size: 12px; font-weight: 700;
}
.checkRow {
  display: flex; gap: 10px; align-items: center; padding: 12px;
  border: 1px solid var(--border); border-radius: 12px; background: #fff;
  cursor: pointer;
}
.checkRow input { width: 20px; height: 20px; margin: 0; accent-color: var(--puck-green); }

.bleBanner {
  display: none; margin-top: 12px; padding: 12px; border-radius: 12px;
  background: #FEF2F2; border: 1px solid #FECACA; color: var(--puck-red);
  font-size: 13px; line-height: 1.4;
}

/* Scoreboard */
.scoreboard { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
.scoreTile {
  border: 1px solid var(--border); border-radius: 20px; padding: 16px;
  background: linear-gradient(180deg, #fff 0%, #F8FAFC 100%); text-align: center;
}
.scoreTile h3 { margin: 0; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
.scoreVal { margin-top: 6px; font-size: 42px; font-weight: 800; color: var(--text); letter-spacing: -1px; }

.infoRow { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
.infoChip {
  padding: 4px 10px; border-radius: 8px; background: var(--chip-bg); border: 1px solid var(--border);
  color: var(--muted); font-size: 11px; font-weight: 700;
}

.gameOver {
  display: none; margin-top: 12px; padding: 16px; border-radius: 16px;
  background: #FEF2F2; border: 2px solid var(--puck-red);
  color: var(--puck-red); text-align: center; font-weight: 800;
}

.log {
  font-family: monospace; font-size: 11px;
  background: #0F172A; color: #E2E8F0;
  border-radius: 12px; padding: 12px;
  max-height: 180px; overflow: auto; white-space: pre-wrap;
}

.toast {
  position: fixed; left: 50%; bottom: 30px; transform: translateX(-50%); z-index: 9999;
  display: none; align-items: center; gap: 10px;
  background: var(--puck-charcoal); color: #fff;
  border-radius: 99px; padding: 12px 24px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2); pointer-events: none;
}
.toast.show { display: flex; animation: toastIn .2s ease-out; }
@keyframes toastIn { from{ transform: translateX(-50%) translateY(10px); opacity:0; } to{ transform: translateX(-50%) translateY(0); opacity:1; } }

/* Mobile Tweaks */
@media (max-width: 480px) {
  .twoCol, .threeCol { grid-template-columns: 1fr; }
  .scoreboard { gap: 10px; }
}
</style>
</head>
<body>
<header>
  <div class="header-title">
    <h1>PlayPUCK</h1>
    <p>Tapping into Sport</p>
  </div>

  <div class="status-bar">
    <div class="status-item">
      <span class="status-label">Role</span>
      <span id="roleDisplay" class="status-val">—</span>
    </div>
    <div class="status-item">
      <span class="status-label">State</span>
      <span id="stateDisplay" class="status-val">IDLE</span>
    </div>
    <div class="status-item">
      <span class="status-label">Status</span>
      <span class="status-val" style="display:flex;align-items:center;">
        <span id="connDot" class="dot"></span>
        <span id="connText">Offline</span>
      </span>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    
    <section class="card" id="cardConnect">
      <div class="cardHeader">
        <div>
          <h2>Connection</h2>
          <p>Connect to your PlayPUCK via Bluetooth.</p>
        </div>
        <div class="stepBadge">1</div>
      </div>
      <div class="cardBody">
        <div class="twoCol">
          <button id="btnConnect" class="accent">Connect</button>
          <button id="btnDisconnect" class="secondary" disabled>Disconnect</button>
        </div>
        
        <div id="bleBanner" class="bleBanner"></div>
        
        <div class="row" style="margin-top:12px;">
          <span class="pill" id="deviceNamePill">Device: —</span>
          <span class="pill" id="rssiPill">RSSI: —</span>
          <span class="pill" id="reconnectPill">Reconnect: —</span>
        </div>

        <div style="margin-top:12px;">
          <label class="checkRow">
            <input id="autoReconnect" type="checkbox" checked>
            <span>Auto-reconnect (Recommended)</span>
          </label>
        </div>
      </div>
    </section>

    <section class="card" id="cardWifi">
      <div class="cardHeader">
        <div>
          <h2>Wi-Fi Setup</h2>
          <p>Manage Cloud Sync credentials.</p>
        </div>
        <div class="stepBadge">2</div>
      </div>
      <div class="cardBody">
        <label>Saved Networks</label>
        <select id="savedWifi">
          <option value="" selected>— Select Saved —</option>
        </select>
        <div class="hint">Stored locally on your device.</div>

        <div class="twoCol" style="margin-top:12px;">
          <div>
            <label>SSID Name</label>
            <input id="wifiSsid" placeholder="e.g. HomeWiFi">
          </div>
          <div>
            <label>Password</label>
            <input id="wifiPass" type="password" placeholder="••••••••">
          </div>
        </div>

        <div style="margin-top:10px;">
           <label class="checkRow">
              <input id="showWifiPass" type="checkbox">
              <span>Show password characters</span>
           </label>
        </div>

        <div class="twoCol" style="margin-top:16px;">
          <button id="btnSendWifi" class="good" disabled>Send to Puck</button>
          <button id="btnSaveWifi" class="secondary">Save Locally</button>
        </div>
        <div class="twoCol" style="margin-top:10px;">
           <button id="btnForgetWifi" class="warn">Forget SSID</button>
           <button id="btnClearWifi" class="danger">Clear All</button>
        </div>
      </div>
    </section>

    <section class="card" id="cardMatch">
      <div class="cardHeader">
        <div>
          <h2>Game Mode</h2>
          <p>Configure rules and profiles.</p>
        </div>
        <div class="stepBadge">3</div>
      </div>
      <div class="cardBody">
        
        <label>Sport</label>
        <select id="sportSelect" style="margin-bottom:12px;">
            <option value="PICKLEBALL" selected>Pickleball</option>
            <option value="TENNIS">Tennis (Future)</option>
            <option value="BADMINTON">Badminton (Future)</option>
        </select>

        <div class="twoCol">
          <div>
            <label>Format</label>
            <select id="matchType">
              <option value="DOUBLES" selected>DOUBLES</option>
              <option value="SINGLES">SINGLES</option>
            </select>
          </div>
          <div>
            <label>Scoring</label>
            <select id="scoringMode">
              <option value="SIDEOUT" selected>SIDEOUT</option>
              <option value="RALLY">RALLY</option>
            </select>
          </div>
        </div>

        <div class="twoCol" style="margin-top:12px;">
          <div>
            <label>Play to...</label>
            <select id="winPointsPreset">
              <option value="7">7 Points</option>
              <option value="11" selected>11 Points</option>
              <option value="15">15 Points</option>
              <option value="21">21 Points</option>
            </select>
          </div>
          <div>
            <label>Win Rule</label>
            <select id="winRule">
              <option value="SUDDEN_DEATH" selected>Sudden Death</option>
              <option value="TWO_CLEAR">Win by 2</option>
            </select>
          </div>
        </div>

        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border);">
            <div class="twoCol">
                <div>
                   <label>Match ID (Optional)</label>
                   <input id="matchId" placeholder="e.g. COURT-1">
                </div>
                <div>
                   <label>Custom Override</label>
                   <select id="customOverride">
                       <option value="OFF" selected>OFF</option>
                       <option value="ON">ON (Use JSON)</option>
                   </select>
                </div>
            </div>
            
            <div style="margin-top:10px;">
              <textarea id="matchJson" placeholder='{"rules":...}'></textarea>
            </div>
        </div>

        <button id="btnUploadProfile" class="accent" style="margin-top:16px;" disabled>Upload Profile to Puck</button>
        <div class="hint" style="text-align:center;">Must be uploaded before starting.</div>
      </div>
    </section>
    <section class="card" id="cardStart">
        <div class="cardHeader">
            <div>
                <h2>Match Control</h2>
                <p>Start or End the active session.</p>
            </div>
            <div class="stepBadge">4</div>
        </div>
        <div class="cardBody">
            <div class="twoCol">
                <button id="btnStartGame" class="good" disabled>Start Game</button>
                <button id="btnEndGame" class="danger" disabled>End Game</button>
            </div>
        </div>
    </section>

    <section class="card" id="cardScore">
      <div class="cardHeader">
        <div>
          <h2>Scoreboard</h2>
          <p>Live scoring and remote inputs.</p>
        </div>
        <div class="stepBadge">5</div>
      </div>
      <div class="cardBody">
        
        <div id="gameOverBanner" class="gameOver">
          GAME OVER<br>
          <span id="gameOverWinner" style="font-size:14px; color:#000;">—</span>
          <br><small id="gameOverSub" style="color:#000; opacity:0.6;">Final: —</small>
        </div>

        <div class="scoreboard">
          <div class="scoreTile">
            <h3>Team A</h3>
            <div id="scoreA" class="scoreVal">0</div>
          </div>
          <div class="scoreTile">
            <h3>Team B</h3>
            <div id="scoreB" class="scoreVal">0</div>
          </div>
        </div>

        <div class="twoCol" style="margin-top:12px;">
            <button id="btnScoreA" class="accent" disabled>+ Point A</button>
            <button id="btnScoreB" class="accent" disabled>+ Point B</button>
        </div>

        <button id="btnUndo" class="secondary" style="margin-top:12px;">Undo Last Action</button>

        <div class="infoRow">
            <span class="infoChip" id="infoServe">Serve: —</span>
            <span class="infoChip" id="infoServerNum">Server: —</span>
            <span class="infoChip" id="infoMode">Mode: —</span>
            <span class="infoChip" id="infoTarget">Target: —</span>
        </div>

        <div style="margin-top:16px; padding-top:16px; border-top:1px dashed var(--border);">
            <label class="checkRow" style="margin-bottom:12px;">
                <input id="chkAutoPauseApply" type="checkbox">
                <span>Auto-pause on rule change</span>
            </label>
            
            <div class="twoCol">
                <button id="btnPauseToggle" class="warn" disabled>Pause Game</button>
                <button id="btnApplyProfileMidMatch" class="secondary" disabled>Update Rules (Mid-game)</button>
            </div>
            <div style="text-align:center; margin-top:10px;">
                 <span class="pill" id="pausePill">Paused: OFF</span>
                 <span class="pill" id="infoPaused">State: Active</span>
            </div>
        </div>
      </div>
    </section>

    <section class="card" id="cardEdit">
      <div class="cardHeader">
        <div>
          <h2>Manual Edit</h2>
          <p>Correction override (Admin only).</p>
        </div>
        <div class="stepBadge">6</div>
      </div>
      <div class="cardBody">
        <div class="twoCol">
            <div>
                <label style="text-align:center;">Team A</label>
                <div class="twoCol">
                    <button id="btnAminus" class="secondary" disabled>−</button>
                    <button id="btnAplus" class="secondary" disabled>+</button>
                </div>
                <div style="display:flex; gap:6px; margin-top:8px;">
                    <input id="setAVal" type="number" value="0" style="text-align:center;">
                    <button id="btnAset" class="warn" style="width:auto;" disabled>Set</button>
                </div>
            </div>
            <div>
                <label style="text-align:center;">Team B</label>
                <div class="twoCol">
                    <button id="btnBminus" class="secondary" disabled>−</button>
                    <button id="btnBplus" class="secondary" disabled>+</button>
                </div>
                <div style="display:flex; gap:6px; margin-top:8px;">
                    <input id="setBVal" type="number" value="0" style="text-align:center;">
                    <button id="btnBset" class="warn" style="width:auto;" disabled>Set</button>
                </div>
            </div>
        </div>
      </div>
    </section>

    <section class="card" id="cardCheckin">
      <div class="cardHeader">
        <div>
            <h2>NFC & Tags</h2>
            <p>Register players and hardware tags.</p>
        </div>
        <div class="stepBadge">7</div>
      </div>
      <div class="cardBody">
        <div class="twoCol">
            <button id="btnNfcScan" class="accent" disabled>Scan NFC</button>
            <button id="btnNfcStop" class="secondary" disabled>Stop</button>
        </div>
        <div id="nfcStatus" class="pill" style="margin-top:10px; width:100%; justify-content:center;">NFC Idle</div>
        
        <div style="margin-top:16px;">
            <label>Manual Player ID</label>
            <div style="display:flex; gap:8px;">
                <input id="checkinPlayerId" placeholder="e.g. P1234">
                <button id="btnCheckinManual" class="good" style="width:auto;" disabled>Check-In</button>
            </div>
        </div>

        <hr style="border:0; border-top:1px solid var(--border); margin:16px 0;">

        <label>Tag Registration</label>
        <div class="twoCol">
            <input id="tagUid" placeholder="Tag UID">
            <select id="tagRole">
                <option value="PLAYER">Player</option>
                <option value="ADMIN">Admin</option>
                <option value="REF">Ref</option>
            </select>
        </div>
        <div class="twoCol" style="margin-top:10px;">
             <button id="btnTagRegister" class="accent" disabled>Register Role</button>
             <button id="btnTagTap" class="good" disabled>Simulate Tap</button>
        </div>

        <label style="margin-top:16px;">Team Assignment</label>
        <div style="display:flex; gap:8px;">
            <select id="tagTeam">
                <option value="A">Team A</option>
                <option value="B">Team B</option>
                <option value="NONE">None</option>
            </select>
            <button id="btnTagAssign" class="secondary" style="width:auto;" disabled>Assign</button>
        </div>

        <div class="twoCol" style="margin-top:16px;">
            <button id="btnTagClearTeams" class="warn" disabled>Clear Teams</button>
            <button id="btnTagClearAll" class="danger" disabled>Reset All Tags</button>
        </div>
      </div>
    </section>

    <section class="card">
        <div class="cardHeader">
            <h2>Debug Log</h2>
        </div>
        <div class="cardBody">
            <div id="log" class="log"></div>
        </div>
    </section>

  </div> </main>

<div id="toast" class="toast">
    <span id="toastText">Action Successful</span>
</div>

<script>
/* -----------------------------------------------------
   PlayPUCK Web Portal - Fixed Protocol
   (All existing logic maintained)
   ----------------------------------------------------- */
const BLE = {
  SERVICE_UUID: 0xFFFF,
  TX_CHAR_UUID: '0000ff01-0000-1000-8000-00805f9b34fb',
  RX_CHAR_UUID: '0000ff02-0000-1000-8000-00805f9b34fb',
};

const el = (id) => document.getElementById(id);
const logEl = el('log');

// Status Bar Elements
const roleDisplay = el('roleDisplay');
const stateDisplay = el('stateDisplay');
const connDot = el('connDot');
const connText = el('connText');
const deviceNamePill = el('deviceNamePill');
const rssiPill = el('rssiPill');
const reconnectPill = el('reconnectPill');
const bleBanner = el('bleBanner');
const toast = el('toast');
const toastText = el('toastText');

function log(msg) {
  const ts = new Date().toLocaleTimeString();
  logEl.textContent = `[${ts}] ${msg}\n` + logEl.textContent;
}

function showToast(t) {
  toastText.textContent = t;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 1300);
}

function vibrate(pattern) {
  try { if (navigator.vibrate) navigator.vibrate(pattern); } catch (_) {}
}

/* --- UTILS --- */
function showBanner(html){
  bleBanner.innerHTML = html; bleBanner.style.display = 'block';
}
function hideBanner(){
  bleBanner.style.display = 'none'; bleBanner.innerHTML = '';
}

// Elements
const btnConnect = el('btnConnect');
const btnDisconnect = el('btnDisconnect');
const autoReconnect = el('autoReconnect');
const savedWifi = el('savedWifi');
const wifiSsid = el('wifiSsid');
const wifiPass = el('wifiPass');
const showWifiPass = el('showWifiPass');
const btnSendWifi = el('btnSendWifi');
const btnSaveWifi = el('btnSaveWifi');
const btnForgetWifi = el('btnForgetWifi');
const btnClearWifi = el('btnClearWifi');

const matchType = el('matchType');
const scoringMode = el('scoringMode');
const winPointsPreset = el('winPointsPreset');
const winRule = el('winRule');
const matchId = el('matchId');
const customOverride = el('customOverride');
const matchJson = el('matchJson');
const btnUploadProfile = el('btnUploadProfile');

const btnStartGame = el('btnStartGame');
const btnEndGame = el('btnEndGame');
const btnScoreA = el('btnScoreA');
const btnScoreB = el('btnScoreB');
const btnUndo = el('btnUndo');

const btnAminus = el('btnAminus');
const btnAplus = el('btnAplus');
const btnAset = el('btnAset');
const btnBminus = el('btnBminus');
const btnBplus = el('btnBplus');
const btnBset = el('btnBset');

const scoreAEl = el('scoreA');
const scoreBEl = el('scoreB');
const setAVal = el('setAVal');
const setBVal = el('setBVal');

const btnNfcScan = el('btnNfcScan');
const btnNfcStop = el('btnNfcStop');
const nfcStatusEl = el('nfcStatus');
const checkinPlayerId = el('checkinPlayerId');
const btnCheckinManual = el('btnCheckinManual');

const tagUid = el('tagUid');
const tagRole = el('tagRole');
const tagTeam = el('tagTeam');
const btnTagRegister = el('btnTagRegister');
const btnTagAssign = el('btnTagAssign');
const btnTagTap = el('btnTagTap');
const btnTagClearTeams = el('btnTagClearTeams');
const btnTagClearAll = el('btnTagClearAll');

let tagSeq = 1;
function normUid(u){ return String(u || '').trim().toUpperCase(); }

const gameOverBanner = el('gameOverBanner');
const gameOverWinner = el('gameOverWinner');
const gameOverSub = el('gameOverSub');

const infoServe = el('infoServe');
const infoServerNum = el('infoServerNum');
const infoMode = el('infoMode');
const infoTarget = el('infoTarget');

const btnPauseToggle = el('btnPauseToggle');
const pausePill = el('pausePill');
const infoPaused = el('infoPaused');
const btnApplyProfileMidMatch = el('btnApplyProfileMidMatch');
const chkAutoPauseApply = el('chkAutoPauseApply');

let device = null;
let server = null;
let service = null;
let txChar = null;
let rxChar = null;
let ndef = null;
let nfcActive = false;
let hadConnectFailure = false;
let reconnectTimer = null;
let reconnectBackoffMs = 900;
const reconnectBackoffMaxMs = 12000;

/* ---------- Original Logic ---------- */
const LS_WIFI_KEY = 'playpuck_wifi_saved_v1';
const LS_STATE_KEY = 'playpuck_last_state_v1';
const LS_AUTORECON_KEY = 'playpuck_auto_reconnect_v1';

function safeJsonParse(s, fallback){
  try{ return JSON.parse(s); }catch(_){ return fallback; }
}

function loadSavedWifi(){
  const arr = safeJsonParse(localStorage.getItem(LS_WIFI_KEY) || '[]', []);
  return Array.isArray(arr) ? arr : [];
}
function saveSavedWifi(arr){ localStorage.setItem(LS_WIFI_KEY, JSON.stringify(arr || [])); }

function renderSavedWifiDropdown(selectedSsid=''){
  const arr = loadSavedWifi().slice().sort((a,b)=>String(a.ssid||'').localeCompare(String(b.ssid||'')));
  savedWifi.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = ''; opt0.textContent = '— Select a saved SSID —';
  savedWifi.appendChild(opt0);
  for(const item of arr){
    const ssid = String(item.ssid || '');
    if(!ssid) continue;
    const o = document.createElement('option');
    o.value = ssid; o.textContent = ssid;
    if(selectedSsid && selectedSsid === ssid) o.selected = true;
    savedWifi.appendChild(o);
  }
}

function upsertWifi(ssid, pass){
  ssid = String(ssid||'').trim(); pass = String(pass||'');
  if(!ssid) throw new Error('SSID is empty.');
  const arr = loadSavedWifi();
  const idx = arr.findIndex(x => String(x.ssid||'') === ssid);
  const entry = { ssid, pass, updated_at: Date.now() };
  if(idx >= 0) arr[idx] = entry; else arr.push(entry);
  saveSavedWifi(arr); renderSavedWifiDropdown(ssid);
}
function forgetWifi(ssid){
  ssid = String(ssid||'').trim(); if(!ssid) return;
  const arr = loadSavedWifi().filter(x => String(x.ssid||'') !== ssid);
  saveSavedWifi(arr); renderSavedWifiDropdown('');
}
function clearAllWifi(){ saveSavedWifi([]); renderSavedWifiDropdown(''); }

savedWifi.addEventListener('change', () => {
  const ssid = savedWifi.value; if(!ssid) return;
  const arr = loadSavedWifi(); const found = arr.find(x => String(x.ssid||'') === ssid);
  if(found){ wifiSsid.value = String(found.ssid||''); wifiPass.value = String(found.pass||''); log(`Loaded: ${ssid}`); }
});
btnSaveWifi.addEventListener('click', () => {
  try{ upsertWifi(wifiSsid.value, wifiPass.value); showToast('Saved Wi-Fi'); }catch(e){ log(e.message); }
});
btnForgetWifi.addEventListener('click', () => {
  const ssid = savedWifi.value || wifiSsid.value.trim();
  forgetWifi(ssid); showToast('Forgot Wi-Fi');
});
btnClearWifi.addEventListener('click', () => { clearAllWifi(); showToast('Cleared Wi-Fi'); });
showWifiPass.addEventListener('change', () => { wifiPass.type = showWifiPass.checked ? 'text' : 'password'; });

function loadAutoReconnect(){ return localStorage.getItem(LS_AUTORECON_KEY) !== '0'; }
function saveAutoReconnect(v){ localStorage.setItem(LS_AUTORECON_KEY, v ? '1' : '0'); }
autoReconnect.checked = loadAutoReconnect();
autoReconnect.addEventListener('change', () => {
  saveAutoReconnect(autoReconnect.checked);
  if(!autoReconnect.checked){ resetReconnect(); setReconnectPill('OFF'); }
  else { setReconnectPill('—'); }
});

let lastState = {
  a: 0, b: 0, serving: null, server_num: null, mode: null, format: null,
  win_points: null, win_rule: null, paused: false, game_over: false, winner: null, role: 'UNKNOWN'
};
function persistLastState(){ try{ localStorage.setItem(LS_STATE_KEY, JSON.stringify(lastState)); }catch(_){} }
function restoreLastState(){
  const obj = safeJsonParse(localStorage.getItem(LS_STATE_KEY) || 'null', null);
  if(obj && typeof obj === 'object') lastState = Object.assign({}, lastState, obj);
}

let bleRxBuffer = ""; let lastMatchId = ""; let lastEpoch = -1; let lastSeq = -1;

function onBleRxChunk(chunk) {
  if (!chunk) return; bleRxBuffer += chunk;
  let idx;
  while ((idx = bleRxBuffer.indexOf("\n")) >= 0) {
    const line = bleRxBuffer.slice(0, idx).trim(); bleRxBuffer = bleRxBuffer.slice(idx + 1);
    if (line) processFrame(line);
  }
  if (bleRxBuffer.length > 4096) bleRxBuffer = "";
}

function setNfcStatus(t){ if(nfcStatusEl) nfcStatusEl.textContent = t; }
function setReconnectPill(text){ reconnectPill.textContent = `Reconnect: ${text}`; }

/* BLE SEND */
async function bleSend(cmd, payloadObj = {}) {
  if (!txChar) throw new Error("Not connected");
  let finalCmd = cmd; let finalPayload = payloadObj ?? {};
  if (cmd === "ACTION") {
    finalCmd = "INPUT";
    finalPayload = { kind: "WEB_CLICK", source: "WEB_PORTAL", seq: Date.now(), ts_ms: Date.now(), payload: payloadObj ?? {} };
  }
  const packet = `${finalCmd} ${JSON.stringify(finalPayload)}\n`;
  const bytes = new TextEncoder().encode(packet);
  const chunkSize = 20;
  for (let i = 0; i < bytes.length; i += chunkSize) {
    await txChar.writeValue(bytes.slice(i, i + chunkSize));
  }
  console.log(`→ ${packet.trim()}`);
}

function setGameOverUI(isOver, winner, a, b){
  if(isOver){
    gameOverBanner.style.display = 'block';
    gameOverWinner.textContent = winner ? `${winner} WINS` : '—';
    gameOverSub.textContent = `Final score: A ${a} - ${b} B`;
  } else {
    gameOverBanner.style.display = 'none';
  }
}

function renderPauseUI(){
  if(!pausePill || !infoPaused || !btnPauseToggle) return;
  const paused = !!lastState.paused;
  const txt = paused ? 'ON' : 'OFF';
  pausePill.textContent = `Pause: ${txt}`; infoPaused.textContent = `State: ${paused?'Paused':'Active'}`;
  btnPauseToggle.textContent = paused ? 'Resume Game' : 'Pause Game';
  btnPauseToggle.className = paused ? 'good' : 'warn';
  if(paused) stateDisplay.textContent = 'PAUSED';
  else if(lastState.game_over) stateDisplay.textContent = 'GAME OVER';
  else stateDisplay.textContent = 'ACTIVE';
}

btnPauseToggle.addEventListener('click', async () => {
  if(!txChar) return;
  try{
    const paused = !!lastState.paused;
    await bleSend('ACTION', { action: paused ? 'RESUME_GAME' : 'PAUSE_GAME' });
    showToast(paused ? 'Resumed' : 'Paused');
  }catch(e){ log(e.message); }
});

function processFrame(frame) {
  try {
    const sp = frame.indexOf(" ");
    const cmd = sp >= 0 ? frame.slice(0, sp) : frame;
    const jsonStr = sp >= 0 ? frame.slice(sp + 1).trim() : "";
    const obj = jsonStr ? JSON.parse(jsonStr) : {};

    if (cmd === "STATE" || cmd === "GET_STATE") {
      const mid = obj.match_id || "";
      const epoch = (obj.authority_epoch ?? -1);
      const seq = (obj.state_seq ?? -1);
      if (mid && mid !== lastMatchId) { lastMatchId = mid; lastEpoch = -1; lastSeq = -1; }
      if (epoch < lastEpoch) return;
      if (epoch === lastEpoch && seq !== -1 && seq <= lastSeq) return;
      lastEpoch = epoch; lastSeq = seq;

      const sState = obj.sport_state || obj;
      lastState.a = sState.a ?? 0;
      lastState.b = sState.b ?? 0;
      lastState.server_team = sState.server_team ?? null;
      lastState.server_num = sState.server_num ?? null;
      lastState.game_over = !!sState.game_over;
      lastState.winner = sState.winner ?? null;
      lastState.paused = !!obj.paused; // Top level paused in new protocol

      const rules = sState.rules || obj.rules;
      if (rules) {
        lastState.win_points = rules.target ?? lastState.win_points;
        const winBy = rules.win_by ?? 2;
        lastState.win_rule = (winBy === 0) ? "SUDDEN_DEATH" : "TWO_CLEAR";
        lastState.matchType = rules.format ?? lastState.matchType;
        lastState.mode = rules.scoring ?? lastState.mode;
      }
      renderStateUI(); renderPauseUI();
      return;
    }
    if (cmd === 'GAME_OVER') {
        lastState.game_over = true; renderStateUI();
        showToast('Game Over');
    }
  } catch (e) { console.error("Parse error", e); }
}

function buildMatchPayload() {
  if (customOverride.value === "ON") {
    let obj; try { obj = JSON.parse(matchJson.value); } catch { throw new Error("Invalid JSON"); }
    if (matchId.value.trim()) obj.match_id = matchId.value.trim();
    return obj;
  }
  return {
    sport: "Pickleball",
    match_id: matchId.value.trim() || undefined,
    rules: {
      target: Number(winPointsPreset.value),
      win_by: (winRule.value === "SUDDEN_DEATH") ? 0 : 2,
      format: matchType.value,
      scoring: scoringMode.value
    }
  };
}
function syncJsonPreview(){
  if(customOverride.value === 'OFF') {
    try{ matchJson.value = JSON.stringify(buildMatchPayload(), null, 2); }catch(_){}
  }
}
[matchType, scoringMode, winPointsPreset, winRule, customOverride, matchId].forEach(x => x.addEventListener('change', syncJsonPreview));
syncJsonPreview();

btnApplyProfileMidMatch.addEventListener('click', async () => {
  if(!txChar) return;
  try{
    const payload = buildMatchPayload();
    const autoPause = !!chkAutoPauseApply?.checked;
    if(autoPause && !lastState.paused) await bleSend('ACTION', { action: 'PAUSE_GAME' });
    await bleSend('PROFILE_SELECT', payload);
    showToast('Rules Updated');
    if(autoPause) setTimeout(async ()=> { if(lastState.paused) await bleSend('ACTION', { action: 'RESUME_GAME' }); }, 500);
  }catch(e){ log(e.message); }
});

/* NFC */
async function startNfcScan() {
  if(!txChar) return setNfcStatus('Connect BLE first');
  if(!('NDEFReader' in window)) return setNfcStatus('Web NFC not supported');
  try {
    ndef = new NDEFReader();
    await ndef.scan();
    nfcActive = true;
    setNfcStatus('Tap tag now...');
    btnNfcStop.disabled = false; btnNfcScan.disabled = true;
    ndef.onreading = async (event) => {
      const sn = event.serialNumber;
      if(sn) {
        log(`NFC: ${sn}`);
        tagUid.value = sn; checkinPlayerId.value = sn;
        btnCheckinManual.disabled = false;
        await bleSend('CHECKIN', { player_id: sn });
        setNfcStatus(`Sent CHECKIN: ${sn}`);
        showToast('Tag Scanned');
      }
    };
  } catch(e) { setNfcStatus(e.message); }
}
btnNfcScan.addEventListener('click', startNfcScan);
btnNfcStop.addEventListener('click', () => { nfcActive=false; btnNfcStop.disabled=true; btnNfcScan.disabled=false; setNfcStatus('Scan stopped'); });

/* TAGS */
btnTagRegister.addEventListener('click', async () => {
    if(!tagUid.value) return; await bleSend('TAG_REGISTER', { uid:normUid(tagUid.value), role:tagRole.value }); showToast('Tag Registered');
});
btnTagAssign.addEventListener('click', async () => {
    if(!tagUid.value) return; await bleSend('TAG_ASSIGN', { uid:normUid(tagUid.value), team:tagTeam.value }); showToast('Tag Assigned');
});
btnTagTap.addEventListener('click', async () => {
    if(!tagUid.value) return; await bleSend('TAG_TAP', { uid:normUid(tagUid.value), seq:tagSeq++ }); showToast('Tap Sent');
});

/* BLE Connection Logic */
function setConnectedUI(connected) {
  if(connected){
    connDot.classList.add('on'); connText.textContent = 'Online';
    btnConnect.className = 'secondary'; btnConnect.disabled = true;
    btnDisconnect.className = 'danger'; btnDisconnect.disabled = false;
    if(autoReconnect.checked) setReconnectPill('—');
  } else {
    connDot.classList.remove('on'); connText.textContent = 'Offline';
    btnConnect.className = 'accent'; btnConnect.disabled = false;
    btnDisconnect.className = 'secondary'; btnDisconnect.disabled = true;
  }
  // Enable buttons
  [btnSendWifi, btnUploadProfile, btnStartGame, btnEndGame, btnPauseToggle, btnApplyProfileMidMatch, btnCheckinManual,
   btnTagRegister, btnTagAssign, btnTagTap, btnTagClearTeams, btnTagClearAll].forEach(b => b.disabled = !connected);
  
  if(connected && 'NDEFReader' in window) btnNfcScan.disabled = false;
  renderStateUI();
}

async function connectBle() {
  try {
    device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [BLE.SERVICE_UUID] });
    deviceNamePill.textContent = device.name;
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(BLE.SERVICE_UUID);
    txChar = await service.getCharacteristic(BLE.TX_CHAR_UUID);
    rxChar = await service.getCharacteristic(BLE.RX_CHAR_UUID);
    await rxChar.startNotifications();
    rxChar.addEventListener('characteristicvaluechanged', (e) => onBleRxChunk(new TextDecoder().decode(e.target.value)));
    setConnectedUI(true); showToast('Connected');
    device.gatt.device.addEventListener('gattserverdisconnected', () => { setConnectedUI(false); if(autoReconnect.checked) scheduleReconnect(); });
  } catch(e) { log(e.message); }
}

function scheduleReconnect(){
    if(reconnectTimer) return;
    setReconnectPill('Retry in 2s');
    reconnectTimer = setTimeout(async () => {
        reconnectTimer = null;
        if(device && !device.gatt.connected) {
            try { await device.gatt.connect(); setConnectedUI(true); } catch(e){ scheduleReconnect(); }
        }
    }, 2000);
}

btnConnect.addEventListener('click', connectBle);
btnDisconnect.addEventListener('click', () => { if(device) device.gatt.disconnect(); });

/* Buttons */
btnUploadProfile.addEventListener('click', async () => { await bleSend('PROFILE_SELECT', buildMatchPayload()); showToast('Profile Uploaded'); });
btnStartGame.addEventListener('click', async () => { await bleSend('START_GAME'); showToast('Game Started'); });
btnEndGame.addEventListener('click', async () => { await bleSend('END_GAME'); showToast('Game Ended'); });

btnScoreA.addEventListener('click', async () => { await bleSend('ACTION', {action:'SCORE_A'}); });
btnScoreB.addEventListener('click', async () => { await bleSend('ACTION', {action:'SCORE_B'}); });
btnUndo.addEventListener('click', async () => { await bleSend('ACTION', {action:'UNDO'}); });

async function sendSync(upd) { await bleSend('SYNC_SET', upd); }
btnAplus.addEventListener('click', ()=> sendSync({a: (lastState.a||0)+1}));
btnAminus.addEventListener('click', ()=> sendSync({a: Math.max(0,(lastState.a||0)-1)}));
btnAset.addEventListener('click', ()=> sendSync({a: Number(setAVal.value)}));
btnBplus.addEventListener('click', ()=> sendSync({b: (lastState.b||0)+1}));
btnBminus.addEventListener('click', ()=> sendSync({b: Math.max(0,(lastState.b||0)-1)}));
btnBset.addEventListener('click', ()=> sendSync({b: Number(setBVal.value)}));

function renderStateUI() {
    const d = lastState;
    if(scoreAEl) scoreAEl.innerText = d.a;
    if(scoreBEl) scoreBEl.innerText = d.b;
    if(setAVal) setAVal.value = d.a;
    if(setBVal) setBVal.value = d.b;
    setGameOverUI(d.game_over, d.winner, d.a, d.b);

    infoServe.textContent = `Serve: ${d.server_team || '—'}`;
    infoServerNum.textContent = `Server: ${d.server_num || '—'}`;
    infoMode.textContent = `Mode: ${d.mode || '—'}`;
    infoTarget.textContent = `Target: ${d.win_points || '—'}`;
}

// Boot
renderSavedWifiDropdown('');
restoreLastState();
renderStateUI();
renderPauseUI();
setConnectedUI(false);
</script>
</body>
</html>
