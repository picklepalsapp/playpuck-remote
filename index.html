<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PlayPUCK BLE Control</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:#e2e8f0;
      --shadow:0 8px 30px rgba(2,8,23,.08);
      --accent:#635bff;      /* purply blue */
      --success:#22c55e;
      --chip:#eef2ff;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg,#fff 0%, var(--bg) 65%);
      color: var(--text);
    }

    header{
      padding:16px;
      position:sticky;
      top:0;
      z-index:20;
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }

    header h1{
      margin:0;
      font-size:18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .status{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid rgba(99,91,255,.15);
      color:var(--muted);
      white-space:nowrap;
    }

    main{ padding:14px; max-width:760px; margin:0 auto; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
      overflow:hidden;
    }

    .cardHeader{
      padding:14px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg,#ffffff 0%, #fbfbff 100%);
    }

    .cardHeader h2{ margin:0; font-size:15px; }

    .cardBody{ padding:14px; }

    .twoCol{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    button{
      -webkit-tap-highlight-color: transparent;
      appearance:none;
      width:100%;
      min-height:48px;
      border-radius:14px;
      border:0;
      padding:12px 14px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(17,24,39,.12);
      transition: transform .06s ease, box-shadow .2s ease, opacity .2s ease;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    button.accent{ background:var(--accent); color:#fff; }
    button.secondary{
      background:#fff;
      border:1px solid var(--border);
      color:var(--text);
      box-shadow:0 8px 18px rgba(2,8,23,.06);
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
      line-height:1.4;
    }

    .bleBanner{
      display:none;
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      background:#fee2e2;
      border:1px solid #fecaca;
      color:#7f1d1d;
      font-size:13px;
      line-height:1.35;
    }
    .bleBanner strong{ font-weight:900; }
    .bleBanner ul{ margin:8px 0 0 18px; padding:0; }

    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px;
      background:#0b1220;
      color:#dbeafe;
      border-radius:14px;
      padding:12px;
      border:1px solid rgba(226,232,240,.14);
      max-height:220px;
      overflow:auto;
      white-space:pre-wrap;
    }

    /* ✅ Green tick toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%);
      z-index:9999;
      display:none;
      align-items:center;
      gap:10px;
      background:#0b1220;
      color:#e5e7eb;
      border:1px solid rgba(226,232,240,.14);
      border-radius:999px;
      padding:10px 14px;
      box-shadow:0 18px 40px rgba(2,8,23,.25);
      pointer-events:none;
    }
    .toast.show{ display:flex; animation: toastIn .18s ease-out; }
    @keyframes toastIn{
      from{ transform: translateX(-50%) translateY(8px); opacity:0; }
      to{ transform: translateX(-50%) translateY(0); opacity:1; }
    }
    .tick{
      width:22px;height:22px;border-radius:999px;
      background:rgba(34,197,94,.16);
      border:1px solid rgba(34,197,94,.35);
      display:grid;place-items:center;
    }
    .tick svg{ width:14px;height:14px;stroke:var(--success);stroke-width:3;fill:none;stroke-linecap:round;stroke-linejoin:round; }
  </style>
</head>

<body>
<header>
  <h1>
    PlayPUCK BLE Control
    <span id="connStatus" class="status">Disconnected</span>
  </h1>
</header>

<main>
  <section class="card">
    <div class="cardHeader"><h2>BLE Connection</h2></div>

    <div class="cardBody">
      <div class="twoCol">
        <button id="btnConnect" class="accent">Connect</button>
        <button id="btnDisconnect" class="secondary" disabled>Disconnect</button>
      </div>

      <div id="bleBanner" class="bleBanner"></div>

      <p class="hint">
        PlayPUCK supports <strong>one BLE connection at a time</strong>. If you used <strong>nRF Connect</strong>,
        disconnect and force-close it (swipe away).
      </p>
    </div>
  </section>

  <section class="card">
    <div class="cardHeader"><h2>Debug log</h2></div>
    <div class="cardBody">
      <div id="log" class="log"></div>
    </div>
  </section>
</main>

<div id="toast" class="toast" aria-live="polite">
  <span class="tick" aria-hidden="true">
    <svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"></path></svg>
  </span>
  <span id="toastText">Connected</span>
</div>

<script>
const BLE={
  SERVICE_UUID:'0000ffff-0000-1000-8000-00805f9b34fb',
  TX_CHAR_UUID:'0000ff01-0000-1000-8000-00805f9b34fb',
  RX_CHAR_UUID:'0000ff02-0000-1000-8000-00805f9b34fb'
};

const logEl=document.getElementById('log');
const connStatus=document.getElementById('connStatus');
const btnConnect=document.getElementById('btnConnect');
const btnDisconnect=document.getElementById('btnDisconnect');
const bleBanner=document.getElementById('bleBanner');
const toast=document.getElementById('toast');
const toastText=document.getElementById('toastText');

let device=null,server=null,service=null,txChar=null,rxChar=null;

let hadConnectFailure=false;
let reconnectBackoffMs=800;         // starts small
const reconnectBackoffMaxMs=12000;  // cap
let reconnectTimer=null;

function log(m){
  const ts=new Date().toLocaleTimeString();
  logEl.textContent=`[${ts}] ${m}\n`+logEl.textContent;
}

function showToast(t){
  toastText.textContent=t;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),1300);
}

function vibrate(pattern){
  try{
    if(navigator.vibrate) navigator.vibrate(pattern);
  }catch(_){}
}

function showBanner(html){
  bleBanner.innerHTML=html;
  bleBanner.style.display='block';
}

function hideBanner(){
  bleBanner.style.display='none';
  bleBanner.innerHTML='';
}

function scheduleReconnect(reason){
  // don't queue multiple
  if(reconnectTimer) return;

  // Only attempt if we have a device handle from a prior user selection
  if(!device){
    log('Auto-reconnect: no previously selected device yet.');
    return;
  }

  const wait=reconnectBackoffMs;
  reconnectBackoffMs=Math.min(Math.floor(reconnectBackoffMs*1.7), reconnectBackoffMaxMs);

  log(`Auto-reconnect scheduled in ${Math.round(wait/100)/10}s (${reason})`);
  reconnectTimer=setTimeout(async ()=>{
    reconnectTimer=null;
    await tryReconnect(true);
  }, wait);
}

function resetReconnectBackoff(){
  reconnectBackoffMs=800;
  if(reconnectTimer){
    clearTimeout(reconnectTimer);
    reconnectTimer=null;
  }
}

function setConnectedUI(c){
  connStatus.textContent=c?'Connected':'Disconnected';

  if(c){
    // Connect -> white disabled; Disconnect -> purple enabled
    btnConnect.className='secondary';
    btnConnect.disabled=true;

    btnDisconnect.className='accent';
    btnDisconnect.disabled=false;

    // Auto-hide banner on success
    hideBanner();
    hadConnectFailure=false;

    resetReconnectBackoff();
  }else{
    // Connect -> purple enabled; Disconnect -> white disabled
    btnConnect.className='accent';
    btnConnect.disabled=false;

    btnDisconnect.className='secondary';
    btnDisconnect.disabled=true;

    // Banner only shows AFTER a failure
    if(hadConnectFailure){
      showBanner(`
        <strong>Connection failed</strong><br>
        If PlayPUCK won’t connect, it’s often still connected in <strong>nRF Connect</strong> or another BLE app.<br><br>
        <ul>
          <li>Disconnect in that app</li>
          <li>Force-close it (swipe away)</li>
          <li>Toggle Bluetooth off/on</li>
        </ul>
      `);
    } else {
      hideBanner();
    }
  }
}

async function connectWithExistingDevice(sourceLabel){
  log(`Connecting (${sourceLabel})…`);
  server = await device.gatt.connect();

  log('Getting service…');
  service = await server.getPrimaryService(BLE.SERVICE_UUID);

  log('Getting characteristics…');
  txChar = await service.getCharacteristic(BLE.TX_CHAR_UUID);
  rxChar = await service.getCharacteristic(BLE.RX_CHAR_UUID);

  try{
    log('Starting notifications…');
    await rxChar.startNotifications();
    rxChar.addEventListener('characteristicvaluechanged', (e) => {
      const txt = new TextDecoder().decode(e.target.value);
      log(`← ${txt}`);
    });
  }catch(e){
    log(`RX notifications not enabled: ${e.message}`);
  }

  setConnectedUI(true);
  log('Connected ✅');
  showToast('Connected ✅');
  vibrate([40, 30, 40]); // short haptic "tick"
}

async function tryReconnect(fromTimer){
  try{
    if(!device) return;

    if(device.gatt?.connected){
      // already back
      return;
    }

    await connectWithExistingDevice(fromTimer ? 'auto-reconnect' : 'reconnect');
  }catch(e){
    hadConnectFailure=true;
    log(`Reconnect error: ${e.message}`);
    setConnectedUI(false);

    // Keep trying (backoff)
    scheduleReconnect('still disconnected');
  }
}

async function manualConnect(){
  try{
    hideBanner();
    hadConnectFailure=false;

    log('Requesting BLE device…');

    device = await navigator.bluetooth.requestDevice({
      filters:[{ namePrefix:'PlayPUCK' }],
      optionalServices:[BLE.SERVICE_UUID]
    });

    device.addEventListener('gattserverdisconnected',()=>{
      log('Disconnected');
      setConnectedUI(false);
      // auto-reconnect loop
      scheduleReconnect('link dropped');
    });

    await connectWithExistingDevice('manual');
  }catch(e){
    hadConnectFailure=true;
    log(`Connect error: ${e.message}`);
    setConnectedUI(false);
  }
}

btnConnect.addEventListener('click', manualConnect);

btnDisconnect.addEventListener('click', ()=>{
  try{
    if(device?.gatt?.connected) device.gatt.disconnect();
  }catch(e){
    log(`Disconnect error: ${e.message}`);
  }
  setConnectedUI(false);
  resetReconnectBackoff(); // manual disconnect should stop reconnect attempts
});

// Optional: if the page becomes visible again, try reconnecting once (no spam)
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState === 'visible' && device && !device.gatt?.connected){
    tryReconnect(false);
  }
});

// Initial
setConnectedUI(false);
log('Ready. Tap Connect.');
</script>

</body>
</html>
